<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="author" content="Willie Lin"><link rel="alternative" href="/atom.xml" title="Willie Lin" type="application/atom+xml"><link rel="icon" href="/favicon.png"><title>使用kubeadm部署kubernetes集群 - Willie Lin</title><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/js/fancybox/jquery.fancybox.min.css"><!--[if lt IE 9]><script>(function(a,b){a="abbr article aside audio bdi canvas data datalist details dialog figcaption figure footer header hgroup main mark meter nav output progress section summary template time video".split(" ");for(b=a.length-1;b>=0;b--)document.createElement(a[b])})()</script><![endif]--><script src="/js/jquery-3.1.1.min.js"></script><script src="/js/fancybox/jquery.fancybox.min.js"></script></head><body style="opacity:0"><header class="head"><h1 class="head-title u-fl"><a href="/">Willie Lin</a></h1><nav class="head-nav u-fr"><ul class="head-nav__list"><li class="head-nav__item"><a class="head-nav__link" href="/archives">カタログ/（目录）</a></li></ul></nav></header><main class="main"><article class="post"><header class="post__head"><time class="post__time" datetime="2019-05-20T06:51:30.000Z">2019 - 05 - 20 14:51:30</time><h1 class="post__title"><a href="/2019/05/20/使用kubeadm部署kubernetes集群/">使用kubeadm部署kubernetes集群</a></h1><div class="post__main echo"><h1 id="1-准备"><a href="#1-准备" class="headerlink" title="1.准备"></a>1.准备</h1><h3 id="1-1-系统配置"><a href="#1-1-系统配置" class="headerlink" title="1.1 系统配置"></a>1.1 系统配置</h3><h4 id="在安装之前，需要先做如下准备。两台CentOS-7-6主机如下："><a href="#在安装之前，需要先做如下准备。两台CentOS-7-6主机如下：" class="headerlink" title="在安装之前，需要先做如下准备。两台CentOS 7.6主机如下："></a>在安装之前，需要先做如下准备。两台CentOS 7.6主机如下：</h4><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/hosts</span><br><span class="line"><span class="number">192.168</span><span class="number">.32</span><span class="number">.87</span> node1</span><br><span class="line"><span class="number">192.168</span><span class="number">.32</span><span class="number">.88</span> node2</span><br></pre></td></tr></table></figure>
<p>如果各个主机启用了防火墙，需要开放Kubernetes各个组件所需要的端口，可以查看Installing kubeadm中的”Check required ports”一节。 这里简单起见在各节点禁用防火墙：</p>
<figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="keyword">stop</span> firewalld</span><br><span class="line">systemctl <span class="keyword">disable</span> firewalld</span><br></pre></td></tr></table></figure>
<p>禁用SELINUX：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">setenforce 0</span><br><span class="line">vi /etc/selinux/config</span><br><span class="line"><span class="attribute">SELINUX</span>=disabled</span><br></pre></td></tr></table></figure></p>
<p>创建/etc/sysctl.d/k8s.conf文件，添加如下内容：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">net<span class="selector-class">.bridge</span><span class="selector-class">.bridge-nf-call-ip6tables</span> = <span class="number">1</span></span><br><span class="line">net<span class="selector-class">.bridge</span><span class="selector-class">.bridge-nf-call-iptables</span> = <span class="number">1</span></span><br><span class="line">net<span class="selector-class">.ipv4</span><span class="selector-class">.ip_forward</span> = <span class="number">1</span></span><br></pre></td></tr></table></figure></p>
<p>执行命令使修改生效。<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">modprobe br_netfilter</span><br><span class="line">sysctl -<span class="selector-tag">p</span> /etc/sysctl.d/k8s.conf</span><br></pre></td></tr></table></figure></p>
<h3 id="1-2-kube-proxy开启ipvs的前置条件"><a href="#1-2-kube-proxy开启ipvs的前置条件" class="headerlink" title="1.2 kube-proxy开启ipvs的前置条件"></a>1.2 kube-proxy开启ipvs的前置条件</h3><p>由于ipvs已经加入到了内核的主干，所以为kube-proxy开启ipvs的前提需要加载以下的内核模块：<br><figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ip_<span class="attr">vs</span></span><br><span class="line"><span class="attr">ip_vs_rr</span></span><br><span class="line"><span class="attr">ip_vs_wrr</span></span><br><span class="line"><span class="attr">ip_vs_sh</span></span><br><span class="line"><span class="attr">nf_conntrack_ipv4</span></span><br></pre></td></tr></table></figure></p>
<p>在所有的Kubernetes节点node1和node2上执行以下脚本:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/sysconfig/modules/ipvs.modules &lt;&lt;EOF</span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">modprobe -- ip_vs</span><br><span class="line">modprobe -- ip_vs_rr</span><br><span class="line">modprobe -- ip_vs_wrr</span><br><span class="line">modprobe -- ip_vs_sh</span><br><span class="line">modprobe -- nf_conntrack_ipv4 </span><br><span class="line"> </span><br><span class="line">EOF</span><br><span class="line">chmod 755 /etc/sysconfig/modules/ipvs.modules &amp;&amp; bash /etc/sysconfig/modules/ipvs.modules &amp;&amp; lsmod | grep -e ip_vs -e nf_conntrack_ipv4</span><br></pre></td></tr></table></figure>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># keruse <span class="symbol">'nf_conntrack</span>' instead <span class="keyword">of</span> <span class="symbol">'nf_conntrack_ipv4</span>' <span class="keyword">for</span> linux kernel &gt;= <span class="number">4.19</span></span><br></pre></td></tr></table></figure>
<p>上面脚本创建了的/etc/sysconfig/modules/ipvs.modules文件，保证在节点重启后能自动加载所需模块。 使用lsmod | grep -e ip_vs -e nf_conntrack_ipv4命令查看是否已经正确加载所需的内核模块。</p>
<p>接下来还需要确保各个节点上已经安装了ipset软件包yum install ipset。 为了便于查看ipvs的代理规则，最好安装一下管理工具ipvsadm yum install ipvsadm。</p>
<p>如果以上前提条件如果不满足，则即使kube-proxy的配置开启了ipvs模式，也会退回到iptables模式。</p>
<h3 id="1-3-安装Docker"><a href="#1-3-安装Docker" class="headerlink" title="1.3 安装Docker"></a>1.3 安装Docker</h3><p>Kubernetes从1.6开始使用CRI(Container Runtime Interface)容器运行时接口。默认的容器运行时仍然是Docker，使用的是kubelet中内置dockershim CRI实现。</p>
<p>内网状态下直接执行：<br><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum <span class="keyword">install</span> docker</span><br></pre></td></tr></table></figure></p>
<p>安装docker的yum源:<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">yum install -<span class="keyword">y</span> yum-utils device-mapper-persistent-data lvm2</span><br><span class="line">yum-config-manager \</span><br><span class="line">    --<span class="built_in">add</span>-repo \</span><br><span class="line">    http<span class="variable">s:</span>//download.docker.<span class="keyword">com</span>/linux/centos/docker-<span class="keyword">ce</span>.repo</span><br><span class="line">查看最新的Docker版本：</span><br><span class="line"></span><br><span class="line">yum <span class="keyword">list</span> docker-<span class="keyword">ce</span>.x86_64  --showduplicates |<span class="keyword">sort</span> -r</span><br><span class="line">docker-<span class="keyword">ce</span>.x86_64            <span class="number">3</span>:<span class="number">18.09</span>.<span class="number">0</span>-<span class="number">3</span>.el7                     docker-<span class="keyword">ce</span>-stable</span><br><span class="line">docker-<span class="keyword">ce</span>.x86_64            <span class="number">18.06</span>.<span class="number">1</span>.<span class="keyword">ce</span>-<span class="number">3</span>.el7                    docker-<span class="keyword">ce</span>-stable</span><br><span class="line">docker-<span class="keyword">ce</span>.x86_64            <span class="number">18.06</span>.<span class="number">0</span>.<span class="keyword">ce</span>-<span class="number">3</span>.el7                    docker-<span class="keyword">ce</span>-stable</span><br><span class="line">docker-<span class="keyword">ce</span>.x86_64            <span class="number">18.03</span>.<span class="number">1</span>.<span class="keyword">ce</span>-<span class="number">1</span>.el7.centos             docker-<span class="keyword">ce</span>-stable</span><br><span class="line">docker-<span class="keyword">ce</span>.x86_64            <span class="number">18.03</span>.<span class="number">0</span>.<span class="keyword">ce</span>-<span class="number">1</span>.el7.centos             docker-<span class="keyword">ce</span>-stable</span><br><span class="line">docker-<span class="keyword">ce</span>.x86_64            <span class="number">17.12</span>.<span class="number">1</span>.<span class="keyword">ce</span>-<span class="number">1</span>.el7.centos             docker-<span class="keyword">ce</span>-stable</span><br><span class="line">docker-<span class="keyword">ce</span>.x86_64            <span class="number">17.12</span>.<span class="number">0</span>.<span class="keyword">ce</span>-<span class="number">1</span>.el7.centos             docker-<span class="keyword">ce</span>-stable</span><br><span class="line">docker-<span class="keyword">ce</span>.x86_64            <span class="number">17.09</span>.<span class="number">1</span>.<span class="keyword">ce</span>-<span class="number">1</span>.el7.centos             docker-<span class="keyword">ce</span>-stable</span><br><span class="line">docker-<span class="keyword">ce</span>.x86_64            <span class="number">17.09</span>.<span class="number">0</span>.<span class="keyword">ce</span>-<span class="number">1</span>.el7.centos             docker-<span class="keyword">ce</span>-stable</span><br><span class="line">docker-<span class="keyword">ce</span>.x86_64            <span class="number">17.06</span>.<span class="number">2</span>.<span class="keyword">ce</span>-<span class="number">1</span>.el7.centos             docker-<span class="keyword">ce</span>-stable</span><br><span class="line">docker-<span class="keyword">ce</span>.x86_64            <span class="number">17.06</span>.<span class="number">1</span>.<span class="keyword">ce</span>-<span class="number">1</span>.el7.centos             docker-<span class="keyword">ce</span>-stable</span><br><span class="line">docker-<span class="keyword">ce</span>.x86_64            <span class="number">17.06</span>.<span class="number">0</span>.<span class="keyword">ce</span>-<span class="number">1</span>.el7.centos             docker-<span class="keyword">ce</span>-stable</span><br><span class="line">docker-<span class="keyword">ce</span>.x86_64            <span class="number">17.03</span>.<span class="number">3</span>.<span class="keyword">ce</span>-<span class="number">1</span>.el7                    docker-<span class="keyword">ce</span>-stable</span><br><span class="line">docker-<span class="keyword">ce</span>.x86_64            <span class="number">17.03</span>.<span class="number">2</span>.<span class="keyword">ce</span>-<span class="number">1</span>.el7.centos             docker-<span class="keyword">ce</span>-stable</span><br><span class="line">docker-<span class="keyword">ce</span>.x86_64            <span class="number">17.03</span>.<span class="number">1</span>.<span class="keyword">ce</span>-<span class="number">1</span>.el7.centos             docker-<span class="keyword">ce</span>-stable</span><br><span class="line">docker-<span class="keyword">ce</span>.x86_64            <span class="number">17.03</span>.<span class="number">0</span>.<span class="keyword">ce</span>-<span class="number">1</span>.el7.centos             docker-<span class="keyword">ce</span>-stable</span><br></pre></td></tr></table></figure></p>
<p>Kubernetes 1.12已经针对Docker的1.11.1, 1.12.1, 1.13.1, 17.03, 17.06, 17.09, 18.06等版本做了验证，需要注意Kubernetes 1.12最低支持的Docker版本是1.11.1。Kubernetes 1.13对Docker的版本依赖方面没有变化。 我们这里在各节点安装docker的18.06.1版本。</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">yum makecache fast</span><br><span class="line"></span><br><span class="line">yum install -y --setopt=obsoletes=<span class="number">0</span> \</span><br><span class="line">  docker-ce<span class="number">-18.06</span><span class="number">.1</span>.ce<span class="number">-3.</span>el7</span><br><span class="line"></span><br><span class="line">systemctl start docker</span><br><span class="line">systemctl enable docker</span><br></pre></td></tr></table></figure>
<p>确认一下iptables filter表中FOWARD链的默认策略(pllicy)为ACCEPT。<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">iptables -nvL</span><br><span class="line">Chain INPUT (policy ACCEPT <span class="number">263</span> packets, <span class="number">19209</span> bytes)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination</span><br><span class="line"></span><br><span class="line">Chain FORWARD (policy ACCEPT <span class="number">0</span> packets, <span class="number">0</span> bytes)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination</span><br><span class="line">    <span class="number">0</span>     <span class="number">0</span> DOCKER-USER  all  --  *      *       <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">0</span>            <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">0</span></span><br><span class="line">    <span class="number">0</span>     <span class="number">0</span> DOCKER-ISOLATION-STAGE<span class="number">-1</span>  all  --  *      *       <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">0</span>            <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">0</span></span><br><span class="line">    <span class="number">0</span>     <span class="number">0</span> ACCEPT     all  --  *      docker0  <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">0</span>            <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">0</span>            ctstate RELATED,ESTABLISHED</span><br><span class="line">    <span class="number">0</span>     <span class="number">0</span> DOCKER     all  --  *      docker0  <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">0</span>            <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">0</span></span><br><span class="line">    <span class="number">0</span>     <span class="number">0</span> ACCEPT     all  --  docker0 !docker0  <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">0</span>            <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">0</span></span><br><span class="line">    <span class="number">0</span>     <span class="number">0</span> ACCEPT     all  --  docker0 docker0  <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">0</span>            <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">0</span></span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>Docker从1.13版本开始调整了默认的防火墙规则，禁用了iptables filter表中FOWARD链，这样会引起Kubernetes集群中跨Node的Pod无法通信。但这里通过安装docker 1806，发现默认策略又改回了ACCEPT，这个不知道是从哪个版本改回的，因为我们线上版本使用的1706还是需要手动调整这个策略的。</p>
</blockquote>
<h1 id="2-使用kubeadm部署Kubernetes"><a href="#2-使用kubeadm部署Kubernetes" class="headerlink" title="2. 使用kubeadm部署Kubernetes"></a>2. 使用kubeadm部署Kubernetes</h1><h3 id="2-1-安装kubeadm和kubelet"><a href="#2-1-安装kubeadm和kubelet" class="headerlink" title="2.1 安装kubeadm和kubelet"></a>2.1 安装kubeadm和kubelet</h3><p> 下面在各节点安装kubeadm和kubelet：<br><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo</span><br><span class="line">[kubernetes]</span><br><span class="line">name=Kubernetes</span><br><span class="line">baseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-x86_64</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=1</span><br><span class="line">repo_gpgcheck=1</span><br><span class="line">gpgkey=https://packages.cloud.google.com/yum/doc/yum-key.gpg</span><br><span class="line">        https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></p>
<p>测试地址<a href="https://packages.cloud.google.com/yum/repos/kubernetes-el7-x86_64是否可用，如果不可用需要科学上网。" target="_blank" rel="noopener">https://packages.cloud.google.com/yum/repos/kubernetes-el7-x86_64是否可用，如果不可用需要科学上网。</a><br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">curl https:<span class="comment">//packages.cloud.google.com/yum/repos/kubernetes-el7-x86_64</span></span><br><span class="line">yum makecache fast</span><br><span class="line">yum install -y kubelet kubeadm kubectl</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Installed:</span><br><span class="line">  kubeadm<span class="selector-class">.x86_64</span> <span class="number">0</span>:<span class="number">1.13</span>.<span class="number">0</span>-<span class="number">0</span>                                    kubectl<span class="selector-class">.x86_64</span> <span class="number">0</span>:<span class="number">1.13</span>.<span class="number">0</span>-<span class="number">0</span>                                                           kubelet<span class="selector-class">.x86_64</span> <span class="number">0</span>:<span class="number">1.13</span>.<span class="number">0</span>-<span class="number">0</span></span><br><span class="line"></span><br><span class="line">Dependency Installed:</span><br><span class="line">  cri-tools<span class="selector-class">.x86_64</span> <span class="number">0</span>:<span class="number">1.12</span>.<span class="number">0</span>-<span class="number">0</span>                                  kubernetes-cni<span class="selector-class">.x86_64</span> <span class="number">0</span>:<span class="number">0.6</span>.<span class="number">0</span>-<span class="number">0</span>                                                       socat<span class="selector-class">.x86_64</span> <span class="number">0</span>:<span class="number">1.7</span>.<span class="number">3.2</span>-<span class="number">2</span>.el7</span><br></pre></td></tr></table></figure></p>
<p>从安装结果可以看出还安装了cri-tools, kubernetes-cni, socat三个依赖：<br>官方从Kubernetes 1.9开始就将cni依赖升级到了0.6.0版本，在当前1.12中仍然是这个版本<br>socat是kubelet的依赖<br>cri-tools是CRI(Container Runtime Interface)容器运行时接口的命令行工具<br>运行kubelet –help可以看到原来kubelet的绝大多数命令行flag参数都被DEPRECATED了，如：<br><figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">--address <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>   The IP address <span class="keyword">for</span> the Kubelet <span class="keyword">to</span> serve <span class="keyword">on</span> (<span class="keyword">set</span> <span class="keyword">to</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span> <span class="keyword">for</span> all IPv4 interfaces <span class="keyword">and</span> `::` <span class="keyword">for</span> all IPv6 interfaces) (<span class="keyword">default</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>) (DEPRECATED: This parameter should be <span class="keyword">set</span> via the config file specified <span class="keyword">by</span> the Kubelet<span class="comment">'s --config flag. See https://kubernetes.io/docs/tasks/administer-cluster/kubelet-config-file/ for more information.)</span></span><br></pre></td></tr></table></figure></p>
<p>而官方推荐我们使用–config指定配置文件，并在配置文件中指定原来这些flag所配置的内容。具体内容可以查看这里Set Kubelet parameters via a config file。这也是Kubernetes为了支持动态Kubelet配置（Dynamic Kubelet Configuration）才这么做的，参考Reconfigure a Node’s Kubelet in a Live Cluster。</p>
<p>kubelet的配置文件必须是json或yaml格式，具体可查看这里。</p>
<p>Kubernetes 1.8开始要求关闭系统的Swap，如果不关闭，默认配置下kubelet将无法启动。</p>
<p>关闭系统的Swap方法如下:<br><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">swapoff -a</span></span><br></pre></td></tr></table></figure></p>
<p>修改 /etc/fstab 文件，注释掉 SWAP 的自动挂载，使用free -m确认swap已经关闭。 swappiness参数调整，修改/etc/sysctl.d/k8s.conf添加下面一行：<br><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">vm.swappiness</span>=<span class="number">0</span></span><br></pre></td></tr></table></figure></p>
<p>执行<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sysctl -<span class="selector-tag">p</span> /etc/sysctl.d/k8s.conf</span><br><span class="line"></span><br><span class="line">使修改生效。</span><br></pre></td></tr></table></figure></p>
<hr>
<p>因为这里本次用于测试两台主机上还运行其他服务，关闭swap可能会对其他服务产生影响，所以这里修改kubelet的配置去掉这个限制。 之前的Kubernetes版本我们都是通过kubelet的启动参数–fail-swap-on=false去掉这个限制的。前面已经分析了Kubernetes不再推荐使用启动参数，而推荐使用配置文件。 所以这里我们改成配置文件配置的形式。</p>
<p>查看/etc/systemd/system/kubelet.service.d/10-kubeadm.conf，看到了下面的内容：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># <span class="doctag">Note:</span> This dropin only works with kubeadm and kubelet v1.11+</span></span><br><span class="line"><span class="section">[Service]</span></span><br><span class="line"><span class="attr">Environment</span>=<span class="string">"KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf"</span></span><br><span class="line"><span class="attr">Environment</span>=<span class="string">"KUBELET_CONFIG_ARGS=--config=/var/lib/kubelet/config.yaml"</span></span><br><span class="line"><span class="comment"># This is a file that "kubeadm init" and "kubeadm join" generates at runtime, populating the KUBELET_KUBEADM_ARGS variable dynamically</span></span><br><span class="line"><span class="attr">EnvironmentFile</span>=-/var/lib/kubelet/kubeadm-flags.env</span><br><span class="line"><span class="comment"># This is a file that the user can use for overrides of the kubelet args as a last resort. Preferably, the user should use</span></span><br><span class="line"><span class="comment"># the .NodeRegistration.KubeletExtraArgs object in the configuration files instead. KUBELET_EXTRA_ARGS should be sourced from this file.</span></span><br><span class="line"><span class="attr">EnvironmentFile</span>=-/etc/sysconfig/kubelet</span><br><span class="line"><span class="attr">ExecStart</span>=</span><br><span class="line"><span class="attr">ExecStart</span>=/usr/bin/kubelet <span class="variable">$KUBELET_KUBECONFIG_ARGS</span> <span class="variable">$KUBELET_CONFIG_ARGS</span> <span class="variable">$KUBELET_KUBEADM_ARGS</span> <span class="variable">$KUBELET_EXTRA_ARGS</span></span><br></pre></td></tr></table></figure>
<p>上面显示kubeadm部署的kubelet的配置文件–config=/var/lib/kubelet/config.yaml，实际去查看/var/lib/kubelet和这个config.yaml的配置文件都没有被创建。 可以猜想肯定是运行kubeadm初始化集群时会自动生成这个配置文件，而如果我们不关闭Swap的话，第一次初始化集群肯定会失败的。</p>
<p>所以还是老老实实的回到使用kubelet的启动参数–fail-swap-on=false去掉必须关闭Swap的限制。 修改/etc/sysconfig/kubelet，加入：<br><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">KUBELET_EXTRA_ARGS</span>=--fail-swap-<span class="literal">on</span>=<span class="literal">false</span></span><br></pre></td></tr></table></figure></p>
<h3 id="2-2-使用kubeadm-init初始化集群"><a href="#2-2-使用kubeadm-init初始化集群" class="headerlink" title="2.2 使用kubeadm init初始化集群"></a>2.2 使用kubeadm init初始化集群</h3><p>在各节点开机启动kubelet服务：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="builtin-name">enable</span> kubelet.service</span><br></pre></td></tr></table></figure></p>
<p>接下来使用kubeadm初始化集群，选择node1作为Master Node，在node1上执行下面的命令：<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubeadm init \</span><br><span class="line">  --kubernetes-version=v1<span class="number">.13</span><span class="number">.0</span> \</span><br><span class="line">  --pod-network-cidr=<span class="number">10.244</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">16</span> \</span><br><span class="line">  --apiserver-advertise-address=<span class="number">192.168</span><span class="number">.61</span><span class="number">.11</span></span><br></pre></td></tr></table></figure></p>
<p>因为我们选择flannel作为Pod网络插件，所以上面的命令指定–pod-network-cidr=10.244.0.0/16。</p>
<p>执行时报了下面的错误：<br><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[init] using Kubernetes version: v1.13.0</span><br><span class="line">[preflight] running pre-flight checks</span><br><span class="line">[preflight] Some fatal errors occurred:</span><br><span class="line">        [ERROR Swap]: running with swap on is<span class="built_in"> not </span>supported. Please disable swap</span><br><span class="line">[preflight] If you know what you are doing, you can make a<span class="built_in"> check </span>non-fatal with `--ignore-preflight-errors=...`</span><br></pre></td></tr></table></figure></p>
<p>有一个错误信息是running with swap on is not supported. Please disable swap。因为我们决定配置failSwapOn: false，所以重新添加–ignore-preflight-errors=Swap参数忽略这个错误，重新运行。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master yyhmmwan]<span class="comment"># kubeadm init \ --kubernetes-version=v1.13.4 \ --pod-network-cidr=10.244.0.0/16 \ --apiserver-a</span></span><br><span class="line">dvertise-address=10.166.0.5 </span><br><span class="line">[init] Using Kubernetes version: v1.13.4</span><br><span class="line">[preflight] Running pre-flight checks</span><br><span class="line">[preflight] Pulling images required for setting up a Kubernetes cluster</span><br><span class="line">[preflight] This might take a minute or two, depending on the speed of your internet connection</span><br><span class="line">[preflight] You can also perform this action in beforehand using 'kubeadm config images pull'</span><br><span class="line">[kubelet-<span class="keyword">start</span>] Writing kubelet environment <span class="keyword">file</span> <span class="keyword">with</span> flags <span class="keyword">to</span> <span class="keyword">file</span> <span class="string">"/var/lib/kubelet/kubeadm-flags.env"</span></span><br><span class="line">[kubelet-<span class="keyword">start</span>] Writing kubelet configuration <span class="keyword">to</span> <span class="keyword">file</span> <span class="string">"/var/lib/kubelet/config.yaml"</span></span><br><span class="line">[kubelet-<span class="keyword">start</span>] Activating the kubelet service</span><br><span class="line">[certs] <span class="keyword">Using</span> certificateDir folder <span class="string">"/etc/kubernetes/pki"</span></span><br><span class="line">[certs] Generating <span class="string">"etcd/ca"</span> certificate <span class="keyword">and</span> <span class="keyword">key</span></span><br><span class="line">[certs] Generating <span class="string">"etcd/server"</span> certificate <span class="keyword">and</span> <span class="keyword">key</span></span><br><span class="line">[certs] etcd/<span class="keyword">server</span> serving cert <span class="keyword">is</span> signed <span class="keyword">for</span> DNS <span class="keyword">names</span> [k8s-<span class="keyword">master</span> localhost] <span class="keyword">and</span> IPs [<span class="number">10.166</span><span class="number">.0</span><span class="number">.4</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> ::<span class="number">1</span>]</span><br><span class="line">[certs] Generating <span class="string">"etcd/peer"</span> certificate <span class="keyword">and</span> <span class="keyword">key</span></span><br><span class="line">[certs] etcd/peer serving cert <span class="keyword">is</span> signed <span class="keyword">for</span> DNS <span class="keyword">names</span> [k8s-<span class="keyword">master</span> localhost] <span class="keyword">and</span> IPs [<span class="number">10.166</span><span class="number">.0</span><span class="number">.4</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> ::<span class="number">1</span>]</span><br><span class="line">[certs] Generating <span class="string">"apiserver-etcd-client"</span> certificate <span class="keyword">and</span> <span class="keyword">key</span></span><br><span class="line">[certs] Generating <span class="string">"etcd/healthcheck-client"</span> certificate <span class="keyword">and</span> <span class="keyword">key</span></span><br><span class="line">[certs] Generating <span class="string">"ca"</span> certificate <span class="keyword">and</span> <span class="keyword">key</span></span><br><span class="line">[certs] Generating <span class="string">"apiserver-kubelet-client"</span> certificate <span class="keyword">and</span> <span class="keyword">key</span></span><br><span class="line">[certs] Generating <span class="string">"apiserver"</span> certificate <span class="keyword">and</span> <span class="keyword">key</span></span><br><span class="line">[certs] apiserver serving cert <span class="keyword">is</span> signed <span class="keyword">for</span> DNS <span class="keyword">names</span> [k8s-<span class="keyword">master</span> kubernetes kubernetes.default kubernetes.default.svc ku</span><br><span class="line">bernetes.default.svc.cluster.local] <span class="keyword">and</span> IPs [<span class="number">10.96</span><span class="number">.0</span><span class="number">.1</span> <span class="number">10.166</span><span class="number">.0</span><span class="number">.4</span>]</span><br><span class="line">[certs] Generating <span class="string">"front-proxy-ca"</span> certificate <span class="keyword">and</span> <span class="keyword">key</span></span><br><span class="line">[certs] Generating <span class="string">"front-proxy-client"</span> certificate <span class="keyword">and</span> <span class="keyword">key</span></span><br><span class="line">[certs] Generating <span class="string">"sa"</span> <span class="keyword">key</span> <span class="keyword">and</span> <span class="keyword">public</span> <span class="keyword">key</span></span><br><span class="line">[kubeconfig] <span class="keyword">Using</span> kubeconfig folder <span class="string">"/etc/kubernetes"</span></span><br><span class="line">[kubeconfig] Writing <span class="string">"admin.conf"</span> kubeconfig <span class="keyword">file</span></span><br><span class="line">[kubeconfig] Writing <span class="string">"kubelet.conf"</span> kubeconfig <span class="keyword">file</span></span><br><span class="line">[kubeconfig] Writing <span class="string">"controller-manager.conf"</span> kubeconfig <span class="keyword">file</span></span><br><span class="line">[kubeconfig] Writing <span class="string">"scheduler.conf"</span> kubeconfig <span class="keyword">file</span></span><br><span class="line">[control-plane] <span class="keyword">Using</span> manifest folder <span class="string">"/etc/kubernetes/manifests"</span></span><br><span class="line">[control-plane] Creating <span class="keyword">static</span> Pod manifest <span class="keyword">for</span> <span class="string">"kube-apiserver"</span></span><br><span class="line">[control-plane] Creating <span class="keyword">static</span> Pod manifest <span class="keyword">for</span> <span class="string">"kube-controller-manager"</span></span><br><span class="line">[control-plane] Creating <span class="keyword">static</span> Pod manifest <span class="keyword">for</span> <span class="string">"kube-scheduler"</span></span><br><span class="line">[etcd] Creating <span class="keyword">static</span> Pod manifest <span class="keyword">for</span> <span class="keyword">local</span> etcd <span class="keyword">in</span> <span class="string">"/etc/kubernetes/manifests"</span></span><br><span class="line">[<span class="keyword">wait</span>-control-plane] Waiting <span class="keyword">for</span> the kubelet <span class="keyword">to</span> boot up the control plane <span class="keyword">as</span> <span class="keyword">static</span> Pods <span class="keyword">from</span> <span class="keyword">directory</span> <span class="string">"/etc/kubernetes/m</span></span><br><span class="line"><span class="string">anifests"</span>. This can take up <span class="keyword">to</span> <span class="number">4</span>m0s</span><br><span class="line">[apiclient] <span class="keyword">All</span> control plane components <span class="keyword">are</span> healthy <span class="keyword">after</span> <span class="number">22.502906</span> <span class="keyword">seconds</span></span><br><span class="line">[uploadconfig] storing the configuration used <span class="keyword">in</span> ConfigMap <span class="string">"kubeadm-config"</span> <span class="keyword">in</span> the <span class="string">"kube-system"</span> Namespace</span><br><span class="line">[kubelet] Creating a ConfigMap <span class="string">"kubelet-config-1.13"</span> <span class="keyword">in</span> namespace kube-<span class="keyword">system</span> <span class="keyword">with</span> the configuration <span class="keyword">for</span> the kubelets <span class="keyword">in</span> t</span><br><span class="line">he cluster</span><br><span class="line">[patchnode] Uploading the CRI Socket information <span class="string">"/var/run/dockershim.sock"</span> <span class="keyword">to</span> the Node API <span class="keyword">object</span> <span class="string">"k8s-master"</span> <span class="keyword">as</span> an anno</span><br><span class="line">tation</span><br><span class="line">[mark-control-plane] Marking the node k8s-<span class="keyword">master</span> <span class="keyword">as</span> control-plane <span class="keyword">by</span> adding the label <span class="string">"node-role.kubernetes.io/master=''"</span></span><br><span class="line">[mark-control-plane] Marking the node k8s-<span class="keyword">master</span> <span class="keyword">as</span> control-plane <span class="keyword">by</span> adding the taints [node-role.kubernetes.io/<span class="keyword">master</span>:NoS</span><br><span class="line">chedule]</span><br><span class="line">[bootstrap-token] <span class="keyword">Using</span> token: <span class="number">29</span>h44u.gqmsznz07dl313l5</span><br><span class="line">[bootstrap-token] Configuring bootstrap tokens, cluster-info ConfigMap, RBAC <span class="keyword">Roles</span></span><br><span class="line">[bootstraptoken] configured RBAC <span class="keyword">rules</span> <span class="keyword">to</span> <span class="keyword">allow</span> Node Bootstrap tokens <span class="keyword">to</span> post CSRs <span class="keyword">in</span> <span class="keyword">order</span> <span class="keyword">for</span> nodes <span class="keyword">to</span> <span class="keyword">get</span> <span class="keyword">long</span> term cer</span><br><span class="line">tificate credentials</span><br><span class="line">[bootstraptoken] configured RBAC <span class="keyword">rules</span> <span class="keyword">to</span> <span class="keyword">allow</span> the csrapprover controller automatically approve CSRs <span class="keyword">from</span> a Node Bootstra</span><br><span class="line">p Token</span><br><span class="line">[bootstraptoken] configured RBAC <span class="keyword">rules</span> <span class="keyword">to</span> <span class="keyword">allow</span> certificate rotation <span class="keyword">for</span> <span class="keyword">all</span> node <span class="keyword">client</span> certificates <span class="keyword">in</span> the cluster</span><br><span class="line">[bootstraptoken] creating the <span class="string">"cluster-info"</span> ConfigMap <span class="keyword">in</span> the <span class="string">"kube-public"</span> namespace</span><br><span class="line">[addons] Applied essential addon: CoreDNS</span><br><span class="line">[addons] Applied essential addon: kube-proxy</span><br><span class="line"></span><br><span class="line">Your Kubernetes <span class="keyword">master</span> has <span class="keyword">initialized</span> successfully!</span><br><span class="line"><span class="keyword">To</span> <span class="keyword">start</span> <span class="keyword">using</span> your cluster, you need <span class="keyword">to</span> run the <span class="keyword">following</span> <span class="keyword">as</span> a regular <span class="keyword">user</span>:</span><br><span class="line">  mkdir -p $HOME/.kube</span><br><span class="line">  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span><br><span class="line">  sudo chown $(<span class="keyword">id</span> -u):$(<span class="keyword">id</span> -g) $HOME/.kube/config</span><br><span class="line">You should <span class="keyword">now</span> deploy a pod network <span class="keyword">to</span> the cluster.</span><br><span class="line">Run <span class="string">"kubectl apply -f [podnetwork].yaml"</span> <span class="keyword">with</span> one <span class="keyword">of</span> the options listed <span class="keyword">at</span>:</span><br><span class="line">  https://kubernetes.io/docs/concepts/cluster-administration/addons/</span><br><span class="line">You can <span class="keyword">now</span> <span class="keyword">join</span> <span class="keyword">any</span> <span class="built_in">number</span> <span class="keyword">of</span> machines <span class="keyword">by</span> running the <span class="keyword">following</span> <span class="keyword">on</span> <span class="keyword">each</span> node</span><br><span class="line"><span class="keyword">as</span> root:</span><br><span class="line">  kubeadm <span class="keyword">join</span> <span class="number">10.166</span><span class="number">.0</span><span class="number">.4</span>:<span class="number">6443</span> </span><br><span class="line"><span class="comment">--token 29h44u.gqmsznz07dl313l5 </span></span><br><span class="line"><span class="comment">--discovery-token-ca-cert-hash </span></span><br><span class="line">sha256:ec7d11d9cdf220310f3aac7fbacceea41ddb7e86be9cf790c247c0c6802a8a7e</span><br><span class="line"><span class="string">``</span><span class="string">` </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">上面记录了完成的初始化输出的内容，根据输出的内容基本上可以看出手动初始化安装一个Kubernetes集群所需要的关键步骤。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">其中有以下关键内容：</span></span><br></pre></td></tr></table></figure>
<p>[kubelet-start] 生成kubelet的配置文件”/var/lib/kubelet/config.yaml”<br>[certificates]生成相关的各种证书<br>[kubeconfig]生成相关的kubeconfig文件<br>[bootstraptoken]生成token记录下来，后边使用kubeadm join往集群中添加节点时会用<br>到下面的命令是配置常规用户如何使用kubectl访问集群：<br> <figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">```</span><br><span class="line">mkdir -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">  sudo cp -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">  sudo chown $(id -u):$(id -g) <span class="variable">$HOME</span>/.kube/config</span><br></pre></td></tr></table></figure></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">最后给出了将节点加入集群的命令</span><br><span class="line">  <span class="selector-tag">kubeadm</span> <span class="selector-tag">join</span> 10<span class="selector-class">.166</span><span class="selector-class">.0</span><span class="selector-class">.4</span><span class="selector-pseudo">:6443</span> </span><br><span class="line"><span class="selector-tag">--token</span> 29<span class="selector-tag">h44u</span><span class="selector-class">.gqmsznz07dl313l5</span> </span><br><span class="line"><span class="selector-tag">--discovery-token-ca-cert-hash</span> </span><br><span class="line"><span class="selector-tag">sha256</span><span class="selector-pseudo">:ec7d11d9cdf220310f3aac7fbacceea41ddb7e86be9cf790c247c0c6802a8a7e</span></span><br></pre></td></tr></table></figure>
<p>查看一下集群状态：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master yyhmmwan]# kubectl <span class="builtin-name">get</span> cs</span><br><span class="line">NAME                 STATUS    MESSAGE              ERROR</span><br><span class="line">controller-manager   Healthy   ok                   </span><br><span class="line">scheduler            Healthy   ok                   </span><br><span class="line">etcd-0               Healthy   &#123;<span class="string">"health"</span>: <span class="string">"true"</span>&#125;</span><br></pre></td></tr></table></figure></p>
<p>确认个组件都处于healthy状态。</p>
<p>集群初始化如果遇到问题，可以使用下面的命令进行清理：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">kubeadm reset</span><br><span class="line">ifconfig cni0 down</span><br><span class="line">ip link delete cni0</span><br><span class="line">ifconfig flannel.1 down</span><br><span class="line">ip link delete flannel.1</span><br><span class="line">rm -rf /var/lib/cni/</span><br></pre></td></tr></table></figure></p>
<h3 id="2-3-安装Pod-Network"><a href="#2-3-安装Pod-Network" class="headerlink" title="2.3 安装Pod Network"></a>2.3 安装Pod Network</h3><p>接下来安装flannel network add-on：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">mkdir -<span class="selector-tag">p</span> ~/k8s/</span><br><span class="line">cd ~/k8s</span><br><span class="line">wget https:<span class="comment">//raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</span></span><br><span class="line">kubectl apply -f  kube-flannel.yml</span><br><span class="line"></span><br><span class="line">clusterrole<span class="selector-class">.rbac</span><span class="selector-class">.authorization</span><span class="selector-class">.k8s</span><span class="selector-class">.io</span>/flannel created</span><br><span class="line">clusterrolebinding<span class="selector-class">.rbac</span><span class="selector-class">.authorization</span><span class="selector-class">.k8s</span><span class="selector-class">.io</span>/flannel created</span><br><span class="line">serviceaccount/flannel created</span><br><span class="line">configmap/kube-flannel-cfg created</span><br><span class="line">daemonset.extensions/kube-flannel-ds-amd64 created</span><br><span class="line">daemonset.extensions/kube-flannel-ds-arm64 created</span><br><span class="line">daemonset.extensions/kube-flannel-ds-arm created</span><br><span class="line">daemonset.extensions/kube-flannel-ds-ppc64le created</span><br><span class="line">daemonset.extensions/kube-flannel-ds-s390x created</span><br></pre></td></tr></table></figure></p>
<p>如果Node有多个网卡的话，参考flannel issues 39701，目前需要在kube-flannel.yml中使用–iface参数指定集群主机内网网卡的名称，否则可能会出现dns无法解析。需要将kube-flannel.yml下载到本地，flanneld启动参数加上–iface=<iface-name><br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">......</span><br><span class="line">containers:</span><br><span class="line"><span class="code">      - name: kube-flannel</span></span><br><span class="line"><span class="code">        image: quay.io/coreos/flannel:v0.10.0-amd64</span></span><br><span class="line"><span class="code">        command:</span></span><br><span class="line"><span class="code">        - /opt/bin/flanneld</span></span><br><span class="line"><span class="code">        args:</span></span><br><span class="line"><span class="code">        - --ip-masq</span></span><br><span class="line"><span class="code">        - --kube-subnet-mgr</span></span><br><span class="line"><span class="code">        - --iface=eth1</span></span><br><span class="line">......</span><br></pre></td></tr></table></figure></iface-name></p>
<p>使用kubectl get pod –all-namespaces -o wide确保所有的Pod都处于Running状态。</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master k8s]# kubectl get pod --all-namespaces -o wide</span><br><span class="line">NAMESPACE     NAME                                 READY   STATUS              RESTARTS   AGE    IP           NODE         NOMINATED NODE   READINESS GATES</span><br><span class="line">kube-system   coredns<span class="number">-86</span>c58d9df4-k5gtz             <span class="number">0</span>/<span class="number">1</span>     ContainerCreating   <span class="number">0</span>          <span class="number">45</span>m    &lt;none&gt;       k8s-node     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   coredns<span class="number">-86</span>c58d9df4-sgnk6             <span class="number">0</span>/<span class="number">1</span>     ContainerCreating   <span class="number">0</span>          <span class="number">45</span>m    &lt;none&gt;       k8s-node     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   etcd-k8s-master                      <span class="number">1</span>/<span class="number">1</span>     Running             <span class="number">1</span>          <span class="number">44</span>m    <span class="number">10.166</span><span class="number">.0</span><span class="number">.4</span>   k8s-master   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   kube-apiserver-k8s-master            <span class="number">1</span>/<span class="number">1</span>     Running             <span class="number">1</span>          <span class="number">44</span>m    <span class="number">10.166</span><span class="number">.0</span><span class="number">.4</span>   k8s-master   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   kube-controller-manager-k8s-master   <span class="number">1</span>/<span class="number">1</span>     Running             <span class="number">1</span>          <span class="number">44</span>m    <span class="number">10.166</span><span class="number">.0</span><span class="number">.4</span>   k8s-master   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   kube-flannel-ds-amd64-gngrk          <span class="number">0</span>/<span class="number">1</span>     CrashLoopBackOff    <span class="number">4</span>          <span class="number">3</span>m7s   <span class="number">10.166</span><span class="number">.0</span><span class="number">.5</span>   k8s-node     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   kube-flannel-ds-amd64-hgftp          <span class="number">0</span>/<span class="number">1</span>     CrashLoopBackOff    <span class="number">4</span>          <span class="number">3</span>m7s   <span class="number">10.166</span><span class="number">.0</span><span class="number">.4</span>   k8s-master   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   kube-proxy<span class="number">-78</span>sj6                     <span class="number">1</span>/<span class="number">1</span>     Running             <span class="number">0</span>          <span class="number">45</span>m    <span class="number">10.166</span><span class="number">.0</span><span class="number">.5</span>   k8s-node     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   kube-proxy-xwbxv                     <span class="number">1</span>/<span class="number">1</span>     Running             <span class="number">2</span>          <span class="number">45</span>m    <span class="number">10.166</span><span class="number">.0</span><span class="number">.4</span>   k8s-master   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   kube-scheduler-k8s-master            <span class="number">1</span>/<span class="number">1</span>     Running             <span class="number">2</span>          <span class="number">44</span>m    <span class="number">10.166</span><span class="number">.0</span><span class="number">.4</span>   k8s-master   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>
<h3 id="2-4-master-node参与工作负载"><a href="#2-4-master-node参与工作负载" class="headerlink" title="2.4 master node参与工作负载"></a>2.4 master node参与工作负载</h3><p>使用kubeadm初始化的集群，出于安全考虑Pod不会被调度到Master Node上，也就是说Master Node不参与工作负载。这是因为当前的master节点node1被打上了node-role.kubernetes.io/master:NoSchedule的污点：<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl describe <span class="keyword">node</span> <span class="title">node1</span> | grep Taint</span><br><span class="line">Taints:             <span class="keyword">node</span><span class="title">-role</span>.kubernetes.io/<span class="literal">master</span>:NoSchedule</span><br></pre></td></tr></table></figure></p>
<p>因为这里搭建的是测试环境，去掉这个污点使node1参与工作负载：<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl taint nodes node1 <span class="keyword">node</span><span class="title">-role</span>.kubernetes.io/<span class="literal">master</span>-</span><br><span class="line"><span class="keyword">node</span> <span class="title">"node1</span><span class="string">" untainted</span></span><br></pre></td></tr></table></figure></p>
<h3 id="2-5-测试DNS"><a href="#2-5-测试DNS" class="headerlink" title="2.5 测试DNS"></a>2.5 测试DNS</h3><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="built_in">run</span> curl <span class="comment">--image=radial/busyboxplus:curl -it</span></span><br><span class="line">kubectl <span class="built_in">run</span> <span class="comment">--generator=deployment/apps.v1beta1 is DEPRECATED and will be removed in a future version. Use kubectl create instead.</span></span><br><span class="line">If you don't see a command prompt, <span class="keyword">try</span> pressing enter.</span><br><span class="line">[ root@curl<span class="number">-5</span>cc7b478b6-r997p:/ ]$</span><br></pre></td></tr></table></figure>
<p>进入后执行nslookup kubernetes.default确认解析正常:<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">nslookup kubernetes.default</span><br><span class="line">Server:    10.96.0.10</span><br><span class="line">Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.local</span><br><span class="line"></span><br><span class="line">Name:      kubernetes.default</span><br><span class="line">Address 1: 10.96.0.1 kubernetes.default.svc.cluster.local</span><br></pre></td></tr></table></figure></p>
</div></header><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a class="post__tag__link" href="/tags/kubeadm-kubernetes-centos7-linux/">kubeadm kubernetes, centos7 linux</a></li></ul></footer></article><section class="reward"><a class="btn-reward" href="#">打赏</a><div class="reward-wrapper clearfix"><img src="/img/wechat20.png" title="微信"></div></section></main><footer class="foot"><div class="foot-copy">&copy; 2016 - 2020 Willie Lin</div></footer><script src="/js/scroller.js"></script><script src="/js/main.js"></script></body></html>