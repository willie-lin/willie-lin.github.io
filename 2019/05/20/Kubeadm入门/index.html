<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="author" content="Willie Lin"><link rel="alternative" href="/atom.xml" title="Willie Lin" type="application/atom+xml"><link rel="icon" href="/favicon.png"><title>Kubeadm入门 - Willie Lin</title><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/js/fancybox/jquery.fancybox.min.css"><!--[if lt IE 9]><script>(function(a,b){a="abbr article aside audio bdi canvas data datalist details dialog figcaption figure footer header hgroup main mark meter nav output progress section summary template time video".split(" ");for(b=a.length-1;b>=0;b--)document.createElement(a[b])})()</script><![endif]--><script src="/js/jquery-3.1.1.min.js"></script><script src="/js/fancybox/jquery.fancybox.min.js"></script></head><body style="opacity:0"><header class="head"><h1 class="head-title u-fl"><a href="/">Willie Lin</a></h1><nav class="head-nav u-fr"><ul class="head-nav__list"><li class="head-nav__item"><a class="head-nav__link" href="/archives">カタログ/（目录）</a></li></ul></nav></header><main class="main"><article class="post"><header class="post__head"><time class="post__time" datetime="2019-05-20T15:48:23.000Z">2019 - 05 - 20 23:48:23</time><h1 class="post__title"><a href="/2019/05/20/Kubeadm入门/">Kubeadm入门</a></h1><div class="post__main echo"><h3 id="第1步-初始化Master"><a href="#第1步-初始化Master" class="headerlink" title="第1步 - 初始化Master"></a>第1步 - 初始化Master</h3><p>Kubeadm已安装在节点上。软件包适用于Ubuntu 16.04 +，CentOS 7或HypriotOS v1.0.1 +。</p>
<p>初始化集群的第一个阶段是启动主节点。主服务器负责运行控制平面组件，etcd和API服务器。客户端将与API通信以调度工作负载并管理群集的状态。</p>
<p>任务<br>以下命令将使用已知令牌初始化集群，以简化以下步骤。<br><figure class="highlight d"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm init --token=<span class="number">102952.1</span>a7dd4cc8d1f4cc5 --kubernetes-<span class="keyword">version</span> $(kubeadm <span class="keyword">version</span> -o <span class="built_in">short</span>)</span><br></pre></td></tr></table></figure></p>
<p>在生产中，建议排除令牌，导致kubeadm代表您生成一个令牌。</p>
<p>要管理Kubernetes集群，需要客户端配置和证书。当kubeadm初始化集群时，将创建此配置。该命令将配置复制到用户主目录，并设置环境变量以供CLI使用。<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo cp /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/</span><br><span class="line">sudo chown $(id -u):$(id -g) <span class="variable">$HOME</span>/admin.conf</span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">KUBECONFIG</span>=<span class="variable">$HOME</span>/admin.conf</span><br></pre></td></tr></table></figure></p>
<h3 id="第2步-加入群集"><a href="#第2步-加入群集" class="headerlink" title="第2步 - 加入群集"></a>第2步 - 加入群集</h3><p>Master初始化后，只要具有正确的令牌，其他节点就可以加入群集。kubeadm token例如，可以通过管理令牌kubeadm token list。</p>
<p>任务<br>在第二个节点上，运行命令以加入提供主节点IP地址的群集。<br><figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kub</span><br><span class="line">```eadm <span class="keyword">join</span> --discovery-token-<span class="keyword">unsafe</span>-<span class="keyword">skip</span>-ca-verification --token=<span class="number">102952.1</span>a7dd4cc8d1f4cc5 <span class="number">172.17</span>.<span class="number">0.100</span>:<span class="number">6443</span></span><br></pre></td></tr></table></figure></p>
<p>这与Master初始化后提供的命令相同。</p>
<p>该–discovery-token-unsafe-skip-ca-verification标记用于绕过发现令牌验证。由于此令牌是动态生成的，因此我们无法将其包含在步骤中。在生产中，使用提供的令牌kubeadm init。</p>
<h3 id="第3步-查看节点"><a href="#第3步-查看节点" class="headerlink" title="第3步 - 查看节点"></a>第3步 - 查看节点</h3><p>群集现已初始化。主节点将管理集群，而我们的一个工作节点将运行我们的容器工作负载。</p>
<p>任务<br>Kubernetes CLI（称为kubectl）现在可以使用该配置来访问群集。例如，以下命令将返回群集中的两个节点。<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="builtin-name">get</span> nodes</span><br></pre></td></tr></table></figure></p>
<p>此时，节点将不会准备就绪。</p>
<p>这是因为尚未部署容器网络接口。这将在下一步中修复。</p>
<h3 id="第4步-部署容器网络接口（CNI）"><a href="#第4步-部署容器网络接口（CNI）" class="headerlink" title="第4步 - 部署容器网络接口（CNI）"></a>第4步 - 部署容器网络接口（CNI）</h3><p>容器网络接口（CNI）定义了不同节点及其工作负载应如何通信。有多个网络提供商可用，其中一些列这里。</p>
<p>任务<br>在这种情况下，我们将使用WeaveWorks。可以在以下位置查看部署定义<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cat</span> /<span class="keyword">opt</span>/weave-kube</span><br></pre></td></tr></table></figure></p>
<p>这可以使用kubectl apply。<br><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">kubectl</span> apply -f /<span class="meta">opt</span>/weave-kube</span><br></pre></td></tr></table></figure></p>
<p>Weave现在将作为一系列Pod部署在集群上。可以使用该命令查看此状态<br><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="built_in">get</span> pod -n kube-<span class="keyword">system</span></span><br></pre></td></tr></table></figure></p>
<p>在群集上安装Weave时，请访问<a href="https://www.weave.works/docs/net/latest/kube-addon/" target="_blank" rel="noopener"> https://www.weave.works/docs/net/latest/kube-addon/</a>了解详细信息。</p>
<h3 id="第5步-部署Pod"><a href="#第5步-部署Pod" class="headerlink" title="第5步 - 部署Pod"></a>第5步 - 部署Pod</h3><p>现在，群集中两个节点的状态应为Ready。这意味着我们可以安排和启动我们的部署。</p>
<p>使用Kubectl，可以部署pod。始终为主服务器发出命令，每个节点仅负责执行工作负载。</p>
<p>下面的命令基于Docker Image katacoda / docker-http-server创建一个Pod 。<br><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="built_in">create</span> deployment <span class="keyword">http</span> <span class="comment">--image=katacoda/docker-http-server:latest</span></span><br></pre></td></tr></table></figure></p>
<p>可以使用查看Pod创建的状态<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="builtin-name">get</span> pods</span><br></pre></td></tr></table></figure></p>
<p>运行后，您可以看到节点上运行的Docker Container。<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="keyword">ps</span> | <span class="keyword">grep</span> docker-http-server</span><br></pre></td></tr></table></figure></p>
</div></header><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a class="post__tag__link" href="/tags/k8s-kubeadm/">k8s kubeadm</a></li></ul></footer></article><section class="reward"><a class="btn-reward" href="#">打赏</a><div class="reward-wrapper clearfix"><img src="/img/wechat20.png" title="微信"></div></section></main><footer class="foot"><div class="foot-copy">&copy; 2016 - 2019 Willie Lin</div></footer><script src="/js/scroller.js"></script><script src="/js/main.js"></script></body></html>