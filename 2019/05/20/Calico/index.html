<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="author" content="Willie Lin"><link rel="alternative" href="/atom.xml" title="Willie Lin" type="application/atom+xml"><link rel="icon" href="/favicon.png"><title>Calico - Willie Lin</title><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/js/fancybox/jquery.fancybox.min.css"><!--[if lt IE 9]><script>(function(a,b){a="abbr article aside audio bdi canvas data datalist details dialog figcaption figure footer header hgroup main mark meter nav output progress section summary template time video".split(" ");for(b=a.length-1;b>=0;b--)document.createElement(a[b])})()</script><![endif]--><script src="/js/jquery-3.1.1.min.js"></script><script src="/js/fancybox/jquery.fancybox.min.js"></script></head><body style="opacity:0"><header class="head"><h1 class="head-title u-fl"><a href="/">Willie Lin</a></h1><nav class="head-nav u-fr"><ul class="head-nav__list"><li class="head-nav__item"><a class="head-nav__link" href="/archives">カタログ/（目录）</a></li></ul></nav></header><main class="main"><article class="post"><header class="post__head"><time class="post__time" datetime="2019-05-20T07:34:31.000Z">2019 - 05 - 20 15:34:31</time><h1 class="post__title"><a href="/2019/05/20/Calico/">Calico</a></h1><div class="post__main echo"><h1 id="Calico"><a href="#Calico" class="headerlink" title="Calico"></a>Calico</h1><p><a href="https://www.projectcalico.org/" target="_blank" rel="noopener">Calico</a>是一个纯三层的数据中心网络方案（不需要 Overlay），并且与 OpenStack、Kubernetes、AWS、GCE 等 IaaS 和容器平台都有良好的集成。</p>
<p>Calico 在每一个计算节点利用 Linux Kernel 实现了一个高效的 vRouter 来负责数据转发，而每个 vRouter 通过 BGP 协议负责把自己上运行的 workload 的路由信息像整个 Calico 网络内传播——小规模部署可以直接互联，大规模下可通过指定的 BGP route reflector 来完成。 这样保证最终所有的 workload 之间的数据流量都是通过 IP 路由的方式完成互联的。Calico 节点组网可以直接利用数据中心的网络结构（无论是 L2 或者 L3），不需要额外的 NAT，隧道或者 Overlay Network。</p>
<p>此外，Calico 基于 iptables 还提供了丰富而灵活的网络 Policy，保证通过各个节点上的 ACLs 来提供 Workload 的多租户隔离、安全组以及其他可达性限制等功能。</p>
<hr>
<h2 id="Calico-架构"><a href="#Calico-架构" class="headerlink" title="Calico 架构"></a>Calico 架构</h2><p><img src="https://raw.githubusercontent.com/Willie-lin/Hexo-Blog-Picture/master/calico/Calico1.png" alt="Calico架构"></p>
<h4 id="Calico-主要由-Felix、etcd、BGP-client-以及-BGP-Route-Reflector-组成"><a href="#Calico-主要由-Felix、etcd、BGP-client-以及-BGP-Route-Reflector-组成" class="headerlink" title="Calico 主要由 Felix、etcd、BGP client 以及 BGP Route Reflector 组成"></a>Calico 主要由 Felix、etcd、BGP client 以及 BGP Route Reflector 组成</h4><ol>
<li>Felix，Calico Agent，跑在每台需要运行 Workload 的节点上，主要负责配置路由及 ACLs 等信息来确保 Endpoint 的连通状态；</li>
<li>etcd，分布式键值存储，主要负责网络元数据一致性，确保 Calico 网络状态的准确性；</li>
<li>BGP Client（BIRD）, 主要负责把 Felix 写入 Kernel 的路由信息分发到当前 Calico 网络，确保 Workload 间的通信的有效性；</li>
<li>BGP Route Reflector（BIRD），大规模部署时使用，摒弃所有节点互联的 mesh 模式，通过一个或者多个 BGP Route Reflector 来完成集中式的路由分发。</li>
<li><p>calico/calico-ipam，主要用作 Kubernetes 的 CNI 插件</p>
<p> <img src="https://raw.githubusercontent.com/Willie-lin/Hexo-Blog-Picture/master/calico/calico2.png" alt="Calico"></p>
</li>
</ol>
<h2 id="IP-in-IP"><a href="#IP-in-IP" class="headerlink" title="IP-in-IP"></a>IP-in-IP</h2><p>Calico 控制平面的设计要求物理网络得是 L2 Fabric，这样 vRouter 间都是直接可达的，路由不需要把物理设备当做下一跳。为了支持 L3 Fabric，Calico 推出了 IPinIP 的选项。</p>
<h2 id="Calico-CNI"><a href="#Calico-CNI" class="headerlink" title="Calico CNI"></a>Calico CNI</h2><p> 参见 <a href="https://github.com/projectcalico/cni-plugin" target="_blank" rel="noopener">https://github.com/projectcalico/cni-plugin</a>。</p>
<h2 id="Calico-CNM"><a href="#Calico-CNM" class="headerlink" title="Calico CNM"></a>Calico CNM</h2><p>Calico 通过 Pool 和 Profile 的方式实现了 docker CNM 网络:</p>
<ol>
<li>Pool，定义可用于 Docker Network 的 IP 资源范围，比如：10.0.0.0/8 或者 192.168.0.0/16;</li>
<li>Profile，定义 Docker Network Policy 的集合，由 tags 和 rules 组成；每个 Profile 默认拥有一个和 Profile 名字相同的 Tag，每个 Profile 可以有多个 Tag，以 List 形式保存。</li>
</ol>
<p>具体实现见 <a href="https://github.com/projectcalico/libnetwork-plugin" target="_blank" rel="noopener">https://github.com/projectcalico/libnetwork-plugin</a>，而使用方法可以参考 <a href="https://docs.projectcalico.org/master/getting-started/docker/" target="_blank" rel="noopener">https://docs.projectcalico.org/master/getting-started/docker/</a>。</p>
<h2 id="Calico-Kubernetes"><a href="#Calico-Kubernetes" class="headerlink" title="Calico Kubernetes"></a>Calico Kubernetes</h2><p>对于使用 kubeadm 创建的 Kubernetes 集群，使用以下配置安装 calico 时需要配置<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">--pod-network-cidr=<span class="number">192.168</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">16</span></span><br><span class="line">--service-cidr=<span class="number">10.96</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">12</span> （不能与 Calico 网络重叠）</span><br></pre></td></tr></table></figure></p>
<p>然后运行<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https:<span class="regexp">//</span>docs.projectcalico.org<span class="regexp">/v3.1/g</span>etting-started<span class="regexp">/kubernetes/i</span>nstallation<span class="regexp">/hosted/</span>rbac-kdd.yaml</span><br><span class="line">kubectl apply -f https:<span class="regexp">//</span>docs.projectcalico.org<span class="regexp">/v3.1/g</span>etting-started<span class="regexp">/kubernetes/i</span>nstallation<span class="regexp">/hosted/</span>kubernetes-datastore<span class="regexp">/calico-networking/</span><span class="number">1.7</span><span class="regexp">/calico.yaml</span></span><br></pre></td></tr></table></figure></p>
<p>更详细的自定义配置方法见 <a href="https://docs.projectcalico.org/v3.0/getting-started/kubernetes" target="_blank" rel="noopener">https://docs.projectcalico.org/v3.0/getting-started/kubernetes</a>。</p>
<p>这会在 Pod 中启动 Calico-etcd，在所有 Node 上启动 bird6、felix 以及 confd，并配置 CNI 网络为 calico 插件：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Calico 相关进程</span></span><br><span class="line">$ ps -ef | grep calico | grep -v grep</span><br><span class="line">root      9012  8995  0 14:51 ?        00:00:00 /bin/sh -c /usr/local/bin/etcd <span class="attribute">--name</span>=calico <span class="attribute">--data-dir</span>=/var/etcd/calico-data <span class="attribute">--advertise-client-urls</span>=http://$CALICO_ETCD_IP:6666 <span class="attribute">--listen-client-urls</span>=http://0.0.0.0:6666 <span class="attribute">--listen-peer-urls</span>=http://0.0.0.0:6667</span><br><span class="line">root      9038  9012  0 14:51 ?        00:00:01 /usr/local/bin/etcd <span class="attribute">--name</span>=calico <span class="attribute">--data-dir</span>=/var/etcd/calico-data <span class="attribute">--advertise-client-urls</span>=http://10.146.0.2:6666 <span class="attribute">--listen-client-urls</span>=http://0.0.0.0:6666 <span class="attribute">--listen-peer-urls</span>=http://0.0.0.0:6667</span><br><span class="line">root      9326  9325  0 14:51 ?        00:00:00 bird6 -R -s /var/run/calico/bird6.ctl -d -c /etc/calico/confd/config/bird6.cfg</span><br><span class="line">root      9327  9322  0 14:51 ?        00:00:00 confd <span class="attribute">-confdir</span>=/etc/calico/confd <span class="attribute">-interval</span>=5 -watch <span class="attribute">--log-level</span>=debug <span class="attribute">-node</span>=http://10.96.232.136:6666 -client-key= -client-cert= -client-ca-keys=</span><br><span class="line">root      9328  9324  0 14:51 ?        00:00:00 bird -R -s /var/run/calico/bird.ctl -d -c /etc/calico/confd/config/bird.cfg</span><br><span class="line">root      9329  9323  1 14:51 ?        00:00:04 calico-felix</span><br></pre></td></tr></table></figure>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># CNI 网络插件配置</span></span><br><span class="line">$ cat <span class="regexp">/etc/</span>cni<span class="regexp">/net.d/</span><span class="number">10</span>-calico.conf</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">"name"</span>: <span class="string">"k8s-pod-network"</span>,</span><br><span class="line">   	<span class="string">"cniVersion"</span>: <span class="string">"0.1.0"</span>,</span><br><span class="line">   	<span class="string">"type"</span>: <span class="string">"calico"</span>,</span><br><span class="line">   	<span class="string">"etcd_endpoints"</span>: <span class="string">"http://10.96.232.136:6666"</span>,</span><br><span class="line">   	<span class="string">"log_level"</span>: <span class="string">"info"</span>,</span><br><span class="line">   	<span class="string">"ipam"</span>: &#123;</span><br><span class="line">       		<span class="string">"type"</span>: <span class="string">"calico-ipam"</span></span><br><span class="line">   		&#125;,</span><br><span class="line">	<span class="string">"policy"</span>: &#123;</span><br><span class="line">       		<span class="string">"type"</span>: <span class="string">"k8s"</span>,</span><br><span class="line">        		<span class="string">"k8s_api_root"</span>: <span class="string">"https://10.96.0.1:443"</span>,</span><br><span class="line">        		<span class="string">"k8s_auth_token"</span>: <span class="string">"&lt;token&gt;"</span></span><br><span class="line">   		&#125;,</span><br><span class="line">   	<span class="string">"kubernetes"</span>: &#123;</span><br><span class="line">       		<span class="string">"kubeconfig"</span>: <span class="string">"/etc/cni/net.d/calico-kubeconfig"</span></span><br><span class="line">	    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">cat</span> <span class="string">/etc/cni/net.d/calico-kubeconfig</span></span><br><span class="line"><span class="comment"># Kubeconfig file for Calico CNI plugin.</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Config</span></span><br><span class="line"><span class="attr">clusters:</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">local</span></span><br><span class="line"> 	      <span class="attr">cluster:</span></span><br><span class="line">   	 <span class="attr">insecure-skip-tls-verify:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">users:</span></span><br><span class="line"><span class="attr">   - name:</span> <span class="string">calico</span></span><br><span class="line"><span class="attr">contexts:</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">calico-context</span></span><br><span class="line"> 	    <span class="attr">context:</span></span><br><span class="line">   	  <span class="attr">cluster:</span> <span class="string">local</span></span><br><span class="line">   	  <span class="attr">user:</span> <span class="string">calico</span></span><br><span class="line"><span class="attr"> current-context:</span> <span class="string">calico-context</span></span><br></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/Willie-lin/Hexo-Blog-Picture/master/calico/calico-flow3.png" alt="calico-flow"></p>
<h2 id="Calico-的不足"><a href="#Calico-的不足" class="headerlink" title="Calico 的不足"></a>Calico 的不足</h2><ol>
<li>既然是三层实现，当然不支持 VRF</li>
<li>不支持多租户网络的隔离功能，在多租户场景下会有网络安全问题</li>
<li>Calico 控制平面的设计要求物理网络得是 L2 Fabric，这样 vRouter 间都是直接可达的<h3 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h3></li>
<li><a href="https://xuxinkun.github.io/2016/07/22/cni-cnm/" target="_blank" rel="noopener">https://xuxinkun.github.io/2016/07/22/cni-cnm/</a></li>
<li><a href="https://www.projectcalico.org/" target="_blank" rel="noopener">https://www.projectcalico.org/</a></li>
<li><a href="http://blog.dataman-inc.com/shurenyun-docker-133/" target="_blank" rel="noopener">http://blog.dataman-inc.com/shurenyun-docker-133/</a></li>
</ol>
</div></header><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a class="post__tag__link" href="/tags/k8s-calico-dns/">k8s calico dns</a></li></ul></footer></article><section class="reward"><a class="btn-reward" href="#">打赏</a><div class="reward-wrapper clearfix"><img src="/img/wechat20.png" title="微信"></div></section></main><footer class="foot"><div class="foot-copy">&copy; 2016 - 2021 Willie Lin</div></footer><script src="/js/scroller.js"></script><script src="/js/main.js"></script></body></html>