<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="author" content="Willie Lin"><link rel="alternative" href="/atom.xml" title="Willie Lin" type="application/atom+xml"><link rel="icon" href="/favicon.png"><title>k8s-API扩展 - Willie Lin</title><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/js/fancybox/jquery.fancybox.min.css"><!--[if lt IE 9]><script>(function(a,b){a="abbr article aside audio bdi canvas data datalist details dialog figcaption figure footer header hgroup main mark meter nav output progress section summary template time video".split(" ");for(b=a.length-1;b>=0;b--)document.createElement(a[b])})()</script><![endif]--><script src="/js/jquery-3.1.1.min.js"></script><script src="/js/fancybox/jquery.fancybox.min.js"></script></head><body style="opacity:0"><header class="head"><h1 class="head-title u-fl"><a href="/">Willie Lin</a></h1><nav class="head-nav u-fr"><ul class="head-nav__list"><li class="head-nav__item"><a class="head-nav__link" href="/archives">カタログ/（目录）</a></li></ul></nav></header><main class="main"><article class="post"><header class="post__head"><time class="post__time" datetime="2019-05-20T15:04:09.000Z">2019 - 05 - 20 23:04:09</time><h1 class="post__title"><a href="/2019/05/20/k8s-API扩展/">k8s-API扩展</a></h1><div class="post__main echo"><h1 id="API-扩展"><a href="#API-扩展" class="headerlink" title="API 扩展"></a>API 扩展</h1><p>Kubernetes 的架构非常灵活，提供了从 API、认证授权、准入控制、网络、存储、运行时以及云平台等一系列的<a href="https://kubernetes.io/docs/concepts/extend-kubernetes/extend-cluster/" target="_blank" rel="noopener">扩展机制</a>，方便用户无侵入的扩展集群的功能。</p>
<p>从 API 的角度来说，可以通过 Aggregation 和 CustomResourceDefinition（CRD） 等扩展 Kubernetes API。</p>
<ul>
<li>API Aggregation 允许在不修改 Kubernetes 核心代码的同时将第三方服务注册到 Kubernetes API 中，这样就可以通过 Kubernetes API 来访问外部服务。</li>
<li>CustomResourceDefinition 则可以在集群中新增资源对象，并可以与已有资源对象（如 Pod、Deployment 等）相同的方式来管理它们。</li>
</ul>
<p>CRD 相比 Aggregation 更易用，两者对比如下</p>
<table>
<thead>
<tr>
<th>CRDs</th>
<th>Aggregated API</th>
</tr>
</thead>
<tbody>
<tr>
<td>无需编程即可使用 CRD 管理资源</td>
<td>需要使用 Go 来构建 Aggregated APIserver</td>
</tr>
<tr>
<td>不需要运行额外服务，但一般需要一个 CRD 控制器同步和管理这些资源</td>
<td>需要独立的第三方服务</td>
</tr>
<tr>
<td>任何缺陷都会在 Kubernetes 核心中修复</td>
<td>可能需要定期从 Kubernetes 社区同步缺陷修复方法并重新构建 Aggregated APIserver.</td>
</tr>
<tr>
<td>无需额外管理版本</td>
<td>需要第三方服务来管理版本</td>
</tr>
</tbody>
</table>
<h2 id="CRD"><a href="#CRD" class="headerlink" title="CRD"></a>CRD</h2><p>CustomResourceDefinition（CRD）是 v1.7 新增的无需改变代码就可以扩展 Kubernetes API 的机制，用来管理自定义对象。它实际上是 <a href="thirdpartyresources.md">ThirdPartyResources（TPR）</a> 的升级版本，而 TPR 已经在 v1.8 中删除。</p>
<h2 id="API-版本对照表"><a href="#API-版本对照表" class="headerlink" title="API 版本对照表"></a>API 版本对照表</h2><table>
<thead>
<tr>
<th>Kubernetes 版本</th>
<th>CRD API 版本</th>
</tr>
</thead>
<tbody>
<tr>
<td>v1.8+</td>
<td>apiextensions.k8s.io/v1beta1</td>
</tr>
</tbody>
</table>
<h2 id="CRD-示例"><a href="#CRD-示例" class="headerlink" title="CRD 示例"></a>CRD 示例</h2><p>下面的例子会创建一个 <code>/apis/stable.example.com/v1/namespaces/&lt;namespace&gt;/crontabs/…</code> 的自定义 API：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apiextensions.k8s.io/v1beta1</span><br><span class="line">kind: CustomResourceDefinition</span><br><span class="line">metadata:</span><br><span class="line">  <span class="comment"># name must match the spec fields below, and be in the form: &lt;plural&gt;.&lt;group&gt;</span></span><br><span class="line">  name: crontabs.stable.example.com</span><br><span class="line">spec:</span><br><span class="line">  <span class="comment"># group name to use for REST API: /apis/&lt;group&gt;/&lt;version&gt;</span></span><br><span class="line">  group: stable.example.com</span><br><span class="line">  <span class="comment"># versions to use for REST API: /apis/&lt;group&gt;/&lt;version&gt;</span></span><br><span class="line">  versions:</span><br><span class="line">  - name: v1beta1</span><br><span class="line">    <span class="comment"># Each version can be enabled/disabled by Served flag.</span></span><br><span class="line">    served: <span class="literal">true</span></span><br><span class="line">    <span class="comment"># One and only one version must be marked as the storage version.</span></span><br><span class="line">    storage: <span class="literal">true</span></span><br><span class="line">  - name: v1</span><br><span class="line">    served: <span class="literal">true</span></span><br><span class="line">    storage: <span class="literal">false</span></span><br><span class="line">  <span class="comment"># either Namespaced or Cluster</span></span><br><span class="line">  scope: Namespaced</span><br><span class="line">  names:</span><br><span class="line">    <span class="comment"># plural name to be used in the URL: /apis/&lt;group&gt;/&lt;version&gt;/&lt;plural&gt;</span></span><br><span class="line">    plural: crontabs</span><br><span class="line">    <span class="comment"># singular name to be used as an alias on the CLI and for display</span></span><br><span class="line">    singular: crontab</span><br><span class="line">    <span class="comment"># kind is normally the CamelCased singular type. Your resource manifests use this.</span></span><br><span class="line">    kind: CronTab</span><br><span class="line">    <span class="comment"># shortNames allow shorter string to match your resource on the CLI</span></span><br><span class="line">    shortNames:</span><br><span class="line">    - ct</span><br></pre></td></tr></table></figure>
<p>API 创建好后，就可以创建具体的 CronTab 对象了</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">$ cat my-cronjob.yaml</span><br><span class="line">apiVersion: <span class="string">"stable.example.com/v1"</span></span><br><span class="line">kind: CronTab</span><br><span class="line">metadata:</span><br><span class="line">  name: my-new-cron-object</span><br><span class="line">spec:</span><br><span class="line">  cronSpec: <span class="string">"* * * * /5"</span></span><br><span class="line">  image: my-awesome-cron-image</span><br><span class="line"></span><br><span class="line">$ kubectl create -f my-crontab.yaml</span><br><span class="line">crontab <span class="string">"my-new-cron-object"</span> created</span><br><span class="line"></span><br><span class="line">$ kubectl get crontab</span><br><span class="line">NAME                 KIND</span><br><span class="line">my-new-cron-object   CronTab.v1.stable.example.com</span><br><span class="line">$ kubectl get crontab my-new-cron-object -o yaml</span><br><span class="line">apiVersion: stable.example.com/v1</span><br><span class="line">kind: CronTab</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: 2017-07-03T19:00:56Z</span><br><span class="line">  name: my-new-cron-object</span><br><span class="line">  namespace: default</span><br><span class="line">  resourceVersion: <span class="string">"20630"</span></span><br><span class="line">  selfLink: /apis/stable.example.com/v1/namespaces/default/crontabs/my-new-cron-object</span><br><span class="line">  uid: 5c82083e-5fbd-11e7-a204-42010a8c0002</span><br><span class="line">spec:</span><br><span class="line">  cronSpec: <span class="string">'* * * * /5'</span></span><br><span class="line">  image: my-awesome-cron-image</span><br></pre></td></tr></table></figure>
<h2 id="Finalizer"><a href="#Finalizer" class="headerlink" title="Finalizer"></a>Finalizer</h2><p>Finalizer 用于实现控制器的异步预删除钩子，可以通过 <code>metadata.finalizers</code> 来指定 Finalizer。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">"stable.example.com/v1"</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CronTab</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  finalizers:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">finalizer.stable.example.com</span></span><br></pre></td></tr></table></figure>
<p>Finalizer 指定后，客户端删除对象的操作只会设置 <code>metadata.deletionTimestamp</code> 而不是直接删除。这会触发正在监听 CRD 的控制器，控制器执行一些删除前的清理操作，从列表中删除自己的 finalizer，然后再重新发起一个删除操作。此时，被删除的对象才会真正删除。</p>
<h2 id="Validation"><a href="#Validation" class="headerlink" title="Validation"></a>Validation</h2><p>v1.8 开始新增了实验性的基于 <a href="https://github.com/OAI/OpenAPI-Specification/blob/master/versions/3.0.0.md#schemaObject" target="_blank" rel="noopener">OpenAPI v3 schema</a> 的验证（Validation）机制，可以用来提前验证用户提交的资源是否符合规范。使用该功能需要配置 kube-apiserver 的 <code>--feature-gates=CustomResourceValidation=true</code>。</p>
<p>比如下面的 CRD 要求</p>
<ul>
<li><code>spec.cronSpec</code> 必须是匹配正则表达式的字符串</li>
<li><code>spec.replicas</code> 必须是从 1 到 10 的整数</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apiextensions.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CustomResourceDefinition</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">crontabs.stable.example.com</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  group:</span> <span class="string">stable.example.com</span></span><br><span class="line"><span class="attr">  version:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">  scope:</span> <span class="string">Namespaced</span></span><br><span class="line"><span class="attr">  names:</span></span><br><span class="line"><span class="attr">    plural:</span> <span class="string">crontabs</span></span><br><span class="line"><span class="attr">    singular:</span> <span class="string">crontab</span></span><br><span class="line"><span class="attr">    kind:</span> <span class="string">CronTab</span></span><br><span class="line"><span class="attr">    shortNames:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">ct</span></span><br><span class="line"><span class="attr">  validation:</span></span><br><span class="line">   <span class="comment"># openAPIV3Schema is the schema for validating custom objects.</span></span><br><span class="line"><span class="attr">    openAPIV3Schema:</span></span><br><span class="line"><span class="attr">      properties:</span></span><br><span class="line"><span class="attr">        spec:</span></span><br><span class="line"><span class="attr">          properties:</span></span><br><span class="line"><span class="attr">            cronSpec:</span></span><br><span class="line"><span class="attr">              type:</span> <span class="string">string</span></span><br><span class="line"><span class="attr">              pattern:</span> <span class="string">'^(\d+|\*)(/\d+)?(\s+(\d+|\*)(/\d+)?)&#123;4&#125;$'</span></span><br><span class="line"><span class="attr">            replicas:</span></span><br><span class="line"><span class="attr">              type:</span> <span class="string">integer</span></span><br><span class="line"><span class="attr">              minimum:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">              maximum:</span> <span class="number">10</span></span><br></pre></td></tr></table></figure>
<p>这样，在创建下面的 CronTab 时</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">"stable.example.com/v1"</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CronTab</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">my-new-cron-object</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  cronSpec:</span> <span class="string">"* * * *"</span></span><br><span class="line"><span class="attr">  image:</span> <span class="string">my-awesome-cron-image</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">15</span></span><br></pre></td></tr></table></figure>
<p>会报验证失败的错误：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">The CronTab <span class="string">"my-new-cron-object"</span> is invalid: []: Invalid value: map[string]interface &#123;&#125;&#123;<span class="string">"apiVersion"</span>:<span class="string">"stable.example.com/v1"</span>, <span class="string">"kind"</span>:<span class="string">"CronTab"</span>, <span class="string">"metadata"</span>:map[string]interface &#123;&#125;&#123;<span class="string">"name"</span>:<span class="string">"my-new-cron-object"</span>, <span class="string">"namespace"</span>:<span class="string">"default"</span>, <span class="string">"deletionTimestamp"</span>:interface &#123;&#125;(nil), <span class="string">"deletionGracePeriodSeconds"</span>:(*int64)(nil), <span class="string">"creationTimestamp"</span>:<span class="string">"2017-09-05T05:20:07Z"</span>, <span class="string">"uid"</span>:<span class="string">"e14d79e7-91f9-11e7-a598-f0761cb232d1"</span>, <span class="string">"selfLink"</span>:<span class="string">""</span>,<span class="string">"clusterName"</span>:<span class="string">""</span>&#125;, <span class="string">"spec"</span>:map[string]interface &#123;&#125;&#123;<span class="string">"cronSpec"</span>:<span class="string">"* * * *"</span>, <span class="string">"image"</span>:<span class="string">"my-awesome-cron-image"</span>, <span class="string">"replicas"</span>:15&#125;&#125;:</span><br><span class="line">validation failure list:</span><br><span class="line">spec.cronSpec <span class="keyword">in</span> body should match <span class="string">'^(\d+|\*)(/\d+)?(\s+(\d+|\*)(/\d+)?)&#123;4&#125;$'</span></span><br><span class="line">spec.replicas <span class="keyword">in</span> body should be less than or equal to 10</span><br></pre></td></tr></table></figure>
<h2 id="Subresources"><a href="#Subresources" class="headerlink" title="Subresources"></a>Subresources</h2><p>v1.10 开始 CRD 还支持 <code>/status</code> 和 <code>/scale</code> 等两个子资源（Beta），并且从 v1.11 开始默认开启。</p>
<blockquote>
<p>v1.10 版本使用前需要在 <code>kube-apiserver</code> 开启 <code>--feature-gates=CustomResourceSubresources=true</code>。</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># resourcedefinition.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apiextensions.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CustomResourceDefinition</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">crontabs.stable.example.com</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  group:</span> <span class="string">stable.example.com</span></span><br><span class="line"><span class="attr">  version:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">  scope:</span> <span class="string">Namespaced</span></span><br><span class="line"><span class="attr">  names:</span></span><br><span class="line"><span class="attr">    plural:</span> <span class="string">crontabs</span></span><br><span class="line"><span class="attr">    singular:</span> <span class="string">crontab</span></span><br><span class="line"><span class="attr">    kind:</span> <span class="string">CronTab</span></span><br><span class="line"><span class="attr">    shortNames:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">ct</span></span><br><span class="line">  <span class="comment"># subresources describes the subresources for custom resources.</span></span><br><span class="line"><span class="attr">  subresources:</span></span><br><span class="line">    <span class="comment"># status enables the status subresource.</span></span><br><span class="line"><span class="attr">    status:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">    <span class="comment"># scale enables the scale subresource.</span></span><br><span class="line"><span class="attr">    scale:</span></span><br><span class="line">      <span class="comment"># specReplicasPath defines the JSONPath inside of a custom resource that corresponds to Scale.Spec.Replicas.</span></span><br><span class="line"><span class="attr">      specReplicasPath:</span> <span class="string">.spec.replicas</span></span><br><span class="line">      <span class="comment"># statusReplicasPath defines the JSONPath inside of a custom resource that corresponds to Scale.Status.Replicas.</span></span><br><span class="line"><span class="attr">      statusReplicasPath:</span> <span class="string">.status.replicas</span></span><br><span class="line">      <span class="comment"># labelSelectorPath defines the JSONPath inside of a custom resource that corresponds to Scale.Status.Selector.</span></span><br><span class="line"><span class="attr">      labelSelectorPath:</span> <span class="string">.status.labelSelector</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create -f resourcedefinition.yaml</span><br><span class="line">$ kubectl create -f- &lt;&lt;EOF</span><br><span class="line">apiVersion: <span class="string">"stable.example.com/v1"</span></span><br><span class="line">kind: CronTab</span><br><span class="line">metadata:</span><br><span class="line">  name: my-new-cron-object</span><br><span class="line">spec:</span><br><span class="line">  cronSpec: <span class="string">"* * * * */5"</span></span><br><span class="line">  image: my-awesome-cron-image</span><br><span class="line">  replicas: 3</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">$ kubectl scale --replicas=5 crontabs/my-new-cron-object</span><br><span class="line">crontabs <span class="string">"my-new-cron-object"</span> scaled</span><br><span class="line"></span><br><span class="line">$ kubectl get crontabs my-new-cron-object -o jsonpath=<span class="string">'&#123;.spec.replicas&#125;'</span></span><br><span class="line">5</span><br></pre></td></tr></table></figure>
<h2 id="Categories"><a href="#Categories" class="headerlink" title="Categories"></a>Categories</h2><p>Categories 用来将 CRD 对象分组，这样就可以使用 <code>kubectl get &lt;category-name&gt;</code> 来查询属于该组的所有对象。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># resourcedefinition.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apiextensions.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CustomResourceDefinition</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">crontabs.stable.example.com</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  group:</span> <span class="string">stable.example.com</span></span><br><span class="line"><span class="attr">  version:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">  scope:</span> <span class="string">Namespaced</span></span><br><span class="line"><span class="attr">  names:</span></span><br><span class="line"><span class="attr">    plural:</span> <span class="string">crontabs</span></span><br><span class="line"><span class="attr">    singular:</span> <span class="string">crontab</span></span><br><span class="line"><span class="attr">    kind:</span> <span class="string">CronTab</span></span><br><span class="line"><span class="attr">    shortNames:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">ct</span></span><br><span class="line">    <span class="comment"># categories is a list of grouped resources the custom resource belongs to.</span></span><br><span class="line"><span class="attr">    categories:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">all</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># my-crontab.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">"stable.example.com/v1"</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CronTab</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">my-new-cron-object</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  cronSpec:</span> <span class="string">"* * * * */5"</span></span><br><span class="line"><span class="attr">  image:</span> <span class="string">my-awesome-cron-image</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create -f resourcedefinition.yaml</span><br><span class="line">$ kubectl create -f my-crontab.yaml</span><br><span class="line">$ kubectl get all</span><br><span class="line">NAME                          AGE</span><br><span class="line">crontabs/my-new-cron-object   3s</span><br></pre></td></tr></table></figure>
<h2 id="CRD-控制器"><a href="#CRD-控制器" class="headerlink" title="CRD 控制器"></a>CRD 控制器</h2><p>在使用 CRD 扩展 Kubernetes API 时，通常还需要实现一个新建资源的控制器，监听新资源的变化情况，并作进一步的处理。</p>
<p><a href="https://github.com/kubernetes/sample-controller" target="_blank" rel="noopener">https://github.com/kubernetes/sample-controller</a> 提供了一个 CRD 控制器的示例，包括</p>
<ul>
<li>如何注册资源 <code>Foo</code></li>
<li>如何创建、删除和查询 <code>Foo</code> 对象</li>
<li>如何监听 <code>Foo</code> 资源对象的变化情况</li>
</ul>
<h2 id="Kubebuilder"><a href="#Kubebuilder" class="headerlink" title="Kubebuilder"></a>Kubebuilder</h2><p>从上面的实例中可以看到从头构建一个 CRD 控制器并不容易，需要对 Kubernetes 的 API 有深入了解，并且RBAC 集成、镜像构建、持续集成和部署等都需要很大工作量。</p>
<p><a href="https://github.com/kubernetes-sigs/kubebuilder" target="_blank" rel="noopener">kubebuilder</a> 正是为解决这个问题而生，为 CRD 控制器提供了一个简单易用的框架，并可直接生成镜像构建、持续集成、持续部署等所需的资源文件。</p>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Install kubebuilder</span></span><br><span class="line">VERSION=1.0.1</span><br><span class="line">wget https://github.com/kubernetes-sigs/kubebuilder/releases/download/v<span class="variable">$&#123;VERSION&#125;</span>/kubebuilder_<span class="variable">$&#123;VERSION&#125;</span>_linux_amd64.tar.gz</span><br><span class="line">tar zxvf kubebuilder_<span class="variable">$&#123;VERSION&#125;</span>_linux_amd64.tar.gz</span><br><span class="line">sudo mv kubebuilder_<span class="variable">$&#123;VERSION&#125;</span>_linux_amd64 /usr/<span class="built_in">local</span>/kubebuilder</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:/usr/<span class="built_in">local</span>/kubebuilder/bin</span><br><span class="line"></span><br><span class="line"><span class="comment"># Install dep kustomize</span></span><br><span class="line">go get -u github.com/golang/dep/cmd/dep</span><br><span class="line">go get github.com/kubernetes-sigs/kustomize</span><br></pre></td></tr></table></figure>
<h3 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h3><h4 id="初始化项目"><a href="#初始化项目" class="headerlink" title="初始化项目"></a>初始化项目</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p <span class="variable">$GOPATH</span>/src/demo</span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$GOPATH</span>/src/demo</span><br><span class="line">kubebuilder init --domain k8s.io --license apache2 --owner <span class="string">"The Kubernetes Authors"</span></span><br></pre></td></tr></table></figure>
<h4 id="创建-API"><a href="#创建-API" class="headerlink" title="创建 API"></a>创建 API</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubebuilder create api --group ships --version v1beta1 --kind Sloop</span><br></pre></td></tr></table></figure>
<p>然后按照实际需要修改 <code>pkg/apis/ship/v1beta1/sloop_types.go</code> 和 <code>pkg/controller/sloop/sloop_controller.go</code> 增加业务逻辑。</p>
<h4 id="本地运行测试"><a href="#本地运行测试" class="headerlink" title="本地运行测试"></a>本地运行测试</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">make install</span><br><span class="line">make run</span><br></pre></td></tr></table></figure>
<blockquote>
<p>如果碰到错误 <code>ValidationError(CustomResourceDefinition.status): missing required field &quot;storedVersions&quot; in io.k8s.apiextensions-apiserver.pkg.apis.apiextensions.v1beta1.CustomResourceDefinitionStatus]</code>，可以手动修改 <code>config/crds/ships_v1beta1_sloop.yaml</code>:<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&gt; status:</span></span><br><span class="line"><span class="string">&gt;   acceptedNames:</span></span><br><span class="line"><span class="string">&gt;     kind: ""</span></span><br><span class="line"><span class="string">&gt;     plural: ""</span></span><br><span class="line"><span class="string">&gt;   conditions: []</span></span><br><span class="line"><span class="string">&gt;   storedVersions: []</span></span><br><span class="line"><span class="string">&gt;</span></span><br><span class="line"><span class="string">&gt; 然后运行 `kubectl apply -f config/crds` 创建 CRD。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">然后就可以用 `ships.k8s.io/v1beta1` 来创建 Kind 为 `Sloop` 的资源了，比如 </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">```sh</span></span><br><span class="line"><span class="string">kubectl apply -f config/samples/ships_v1beta1_sloop.yaml</span></span><br></pre></td></tr></table></figure></p>
</blockquote>
<h4 id="构建镜像并部署控制器"><a href="#构建镜像并部署控制器" class="headerlink" title="构建镜像并部署控制器"></a>构建镜像并部署控制器</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 替换 IMG 为你自己的</span></span><br><span class="line"><span class="built_in">export</span> IMG=feisky/demo-crd:v1</span><br><span class="line">make docker-build</span><br><span class="line">make docker-push</span><br><span class="line">make deploy</span><br></pre></td></tr></table></figure>
<blockquote>
<p>kustomize 已经不再支持通配符，因而上述 <code>make deploy</code> 可能会碰到 <code>Load from path ../rbac/*.yaml failed</code> 错误，解决方法是手动修改 <code>config/default/kustomization.yaml</code>:</p>
<p>resources:</p>
<ul>
<li>../rbac/rbac_role.yaml</li>
<li>../rbac/rbac_role_binding.yaml</li>
<li>../manager/manager.yaml</li>
</ul>
<p>然后执行 <code>kustomize build config/default | kubectl apply -f -</code> 部署，默认部署到 <code>demo-system</code> namespace 中。</p>
</blockquote>
<h4 id="文档和测试"><a href="#文档和测试" class="headerlink" title="文档和测试"></a>文档和测试</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># run unit tests</span></span><br><span class="line">make <span class="built_in">test</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># generate docs</span></span><br><span class="line">kubebuilder docs</span><br></pre></td></tr></table></figure>
<h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><ul>
<li><a href="https://kubernetes.io/docs/tasks/access-kubernetes-api/extend-api-custom-resource-definitions/#validation" target="_blank" rel="noopener">Extend the Kubernetes API with CustomResourceDefinitions</a></li>
<li><a href="https://kubernetes.io/docs/api-reference/v1.8/#customresourcedefinition-v1beta1-apiextensions" target="_blank" rel="noopener">CustomResourceDefinition API</a></li>
</ul>
<p>详细的使用方法请参考</p>
<ul>
<li><a href="aggregation.md">Aggregation</a></li>
<li><a href="../concepts/customresourcedefinition.md">CustomResourceDefinition</a></li>
</ul>
</div></header><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a class="post__tag__link" href="/tags/k8s/">k8s</a></li></ul></footer></article><section class="reward"><a class="btn-reward" href="#">打赏</a><div class="reward-wrapper clearfix"><img src="/img/wechat20.png" title="微信"></div></section></main><footer class="foot"><div class="foot-copy">&copy; 2016 - 2021 Willie Lin</div></footer><script src="/js/scroller.js"></script><script src="/js/main.js"></script></body></html>