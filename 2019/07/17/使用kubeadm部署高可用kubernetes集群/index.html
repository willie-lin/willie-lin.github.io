<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="author" content="Willie Lin"><link rel="alternative" href="/atom.xml" title="Willie Lin" type="application/atom+xml"><link rel="icon" href="/favicon.png"><title>使用kubeadm部署高可用kubernetes集群 - Willie Lin</title><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/js/fancybox/jquery.fancybox.min.css"><!--[if lt IE 9]><script>(function(a,b){a="abbr article aside audio bdi canvas data datalist details dialog figcaption figure footer header hgroup main mark meter nav output progress section summary template time video".split(" ");for(b=a.length-1;b>=0;b--)document.createElement(a[b])})()</script><![endif]--><script src="/js/jquery-3.1.1.min.js"></script><script src="/js/fancybox/jquery.fancybox.min.js"></script></head><body style="opacity:0"><header class="head"><h1 class="head-title u-fl"><a href="/">Willie Lin</a></h1><nav class="head-nav u-fr"><ul class="head-nav__list"><li class="head-nav__item"><a class="head-nav__link" href="/archives">カタログ/（目录）</a></li></ul></nav></header><main class="main"><article class="post"><header class="post__head"><time class="post__time" datetime="2019-07-17T02:33:53.000Z">2019 - 07 - 17 10:33:53</time><h1 class="post__title"><a href="/2019/07/17/使用kubeadm部署高可用kubernetes集群/">使用kubeadm部署高可用kubernetes集群</a></h1><div class="post__main echo"><h1 id="kubernetes-1-15-0"><a href="#kubernetes-1-15-0" class="headerlink" title="kubernetes 1.15.0"></a>kubernetes 1.15.0</h1><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">本文基于 kubeadm 方式部署，kubeadm 在<span class="number">1.13</span> 版本以后正式进入 GA.</span><br><span class="line">目前国内各大厂商都有 kubeadm 的镜像源，对于部署 kubernetes 来说是大大的便利.</span><br><span class="line">从官方对 kubeadm 的更新频繁度来看，kubeadm 应该是后面的趋势，毕竟二进制部署确实麻烦了点.</span><br></pre></td></tr></table></figure>
<h3 id="1-概述"><a href="#1-概述" class="headerlink" title="1. 概述"></a>1. 概述</h3><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">本次部署使用非独立的<span class="selector-tag">etcd</span>集群, 与<span class="selector-tag">master</span>节点混布. </span><br><span class="line">部署环境为<span class="selector-tag">CentOS</span> 7<span class="selector-class">.6</span>, 默认内核版本为3<span class="selector-class">.10</span>, 缺少<span class="selector-tag">ip_vs_fo</span><span class="selector-class">.ko</span>模块, 将使<span class="selector-tag">kube-proxy</span>无法启用<span class="selector-tag">ipvs</span>功能,</span><br><span class="line">目前最新稳定版内核为5<span class="selector-class">.0</span>, 同时<span class="selector-tag">Kubernetes</span> 1<span class="selector-class">.15</span>也支持, 故此处会讲内核升级到最新稳定版部署架构如下, 三个<span class="selector-tag">master</span>节点, 三个<span class="selector-tag">worker</span>节点</span><br></pre></td></tr></table></figure>
<p> <img src="https://github.com/willie-lin/Hexo-Blog-Picture/blob/master/kubernetes/kubeadm-ha-topology-stacked-etcd.svg" alt="kubeadm"></p>
<h3 id="1-1-环境说明"><a href="#1-1-环境说明" class="headerlink" title="1.1 环境说明"></a>1.1 环境说明</h3><table>
<thead>
<tr>
<th>HOST</th>
<th>IP</th>
<th>Hostname</th>
<th>Hardware env</th>
<th>Role</th>
</tr>
</thead>
<tbody>
<tr>
<td>Master1</td>
<td>10.122.144.153</td>
<td>k8s-master1</td>
<td>4Core 4G</td>
<td>master</td>
</tr>
<tr>
<td>Master2</td>
<td>10.122.144.154</td>
<td>k8s-master2</td>
<td>4Core 4G</td>
<td>master</td>
</tr>
<tr>
<td>Master3</td>
<td>10.122.144.155</td>
<td>k8s-master3</td>
<td>4Core 4G</td>
<td>master</td>
</tr>
<tr>
<td>LSB1</td>
<td>10.122.144.150</td>
<td>LSB1</td>
<td>4Core 4G</td>
<td>LSB1</td>
</tr>
<tr>
<td>LSB2</td>
<td>10.122.144.151</td>
<td>LSB2</td>
<td>4Core 4G</td>
<td>LSB2</td>
</tr>
<tr>
<td>VIP</td>
<td>10.122.144.152</td>
<td>VIP</td>
<td>4Core 4G</td>
<td>VIP</td>
</tr>
<tr>
<td>Worker1</td>
<td>10.122.144.156</td>
<td>k8s-node1</td>
<td>4Core 4G</td>
<td>node</td>
</tr>
<tr>
<td>Worker2</td>
<td>10.122.144.157</td>
<td>k8s-node2</td>
<td>4Core 4G</td>
<td>node</td>
</tr>
<tr>
<td>Worker3</td>
<td>10.122.144.158</td>
<td>k8s-node3</td>
<td>4Core 4G</td>
<td>node</td>
</tr>
</tbody>
</table>
<h3 id="1-2-基础环境"><a href="#1-2-基础环境" class="headerlink" title="1.2 基础环境"></a>1.2 基础环境</h3><ul>
<li><p>所有节点关闭不必要的服务</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">systemctl disable <span class="comment">--now firewalld</span></span><br><span class="line">setenforce <span class="number">0</span></span><br><span class="line">sed -i <span class="string">'s@SELINUX=enforcing@SELINUX=disabled@'</span> /etc/selinux/<span class="built_in">config</span></span><br><span class="line">systemctl disable <span class="comment">--now NetworkManager</span></span><br><span class="line">systemctl disable <span class="comment">--now dnsmasq</span></span><br></pre></td></tr></table></figure>
<p>创建/etc/sysctl.d/k8s.conf文件，添加如下内容：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">net<span class="selector-class">.bridge</span><span class="selector-class">.bridge-nf-call-ip6tables</span> = <span class="number">1</span></span><br><span class="line">net<span class="selector-class">.bridge</span><span class="selector-class">.bridge-nf-call-iptables</span> = <span class="number">1</span></span><br><span class="line">net<span class="selector-class">.ipv4</span><span class="selector-class">.ip_forward</span> = <span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>执行命令使修改生效。</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">modprobe br_netfilter</span><br><span class="line">sysctl -<span class="selector-tag">p</span> /etc/sysctl.d/k8s.conf</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="1-2-1-kube-proxy开启ipvs的前置条件"><a href="#1-2-1-kube-proxy开启ipvs的前置条件" class="headerlink" title="1.2.1 kube-proxy开启ipvs的前置条件"></a>1.2.1 kube-proxy开启ipvs的前置条件</h3><p> 由于ipvs已经加入到了内核的主干，所以为kube-proxy开启ipvs的前提需要加载以下的内核模块：<br> <figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ip_vs</span><br><span class="line">ip_vs_rr</span><br><span class="line">ip_vs_wrr</span><br><span class="line">ip_vs_sh</span><br><span class="line">nf_conntrack</span><br></pre></td></tr></table></figure></p>
<p> 在所有的Kubernetes节点node1和node2上执行以下脚本:</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/sysconfig/modules/ipvs.modules &lt;&lt;EOF</span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">modprobe -- ip_vs</span><br><span class="line">modprobe -- ip_vs_rr</span><br><span class="line">modprobe -- ip_vs_wrr</span><br><span class="line">modprobe -- ip_vs_sh</span><br><span class="line">modprobe -- nf_conntrack_ipv4 </span><br><span class="line"> </span><br><span class="line">EOF</span><br><span class="line">chmod 755 /etc/sysconfig/modules/ipvs.modules &amp;&amp; bash /etc/sysconfig/modules/ipvs.modules &amp;&amp; lsmod | grep -e ip_vs -e nf_conntrack</span><br></pre></td></tr></table></figure>
 <figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># keruse <span class="symbol">'nf_conntrack</span>' instead <span class="keyword">of</span> <span class="symbol">'nf_conntrack_ipv4</span>' <span class="keyword">for</span> linux kernel &gt;= <span class="number">4.19</span></span><br></pre></td></tr></table></figure>
<p> 上面脚本创建了的/etc/sysconfig/modules/ipvs.modules文件，保证在节点重启后能自动加载所需模块。 使用lsmod | grep -e ip_vs -e nf_conntrack_ipv4命令查看是否已经正确加载所需的内核模块。</p>
<p> 接下来还需要确保各个节点上已经安装了ipset软件包yum install ipset。 为了便于查看ipvs的代理规则，最好安装一下管理工具ipvsadm yum install ipvsadm。</p>
<p> 如果以上前提条件如果不满足，则即使kube-proxy的配置开启了ipvs模式，也会退回到iptables模式。</p>
<h3 id="1-3-安装Docker"><a href="#1-3-安装Docker" class="headerlink" title="1.3 安装Docker"></a>1.3 安装Docker</h3><p> Kubernetes从1.6开始使用CRI(Container Runtime Interface)容器运行时接口。默认的容器运行时仍然是Docker，使用的是kubelet中内置dockershim CRI实现。</p>
<p> 内网状态下直接执行：<br> <figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum <span class="keyword">install</span> docker</span><br></pre></td></tr></table></figure></p>
<p> 安装docker的yum源:<br> <figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">yum install -<span class="keyword">y</span> yum-utils device-mapper-persistent-data lvm2</span><br><span class="line">yum-config-manager \</span><br><span class="line">    --<span class="built_in">add</span>-repo \</span><br><span class="line">    http<span class="variable">s:</span>//download.docker.<span class="keyword">com</span>/linux/centos/docker-<span class="keyword">ce</span>.repo</span><br><span class="line">查看最新的Docker版本：</span><br><span class="line"></span><br><span class="line">yum <span class="keyword">list</span> docker-<span class="keyword">ce</span>.x86_64  --showduplicates |<span class="keyword">sort</span> -r</span><br><span class="line">docker-<span class="keyword">ce</span>.x86_64            <span class="number">3</span>:<span class="number">18.09</span>.<span class="number">0</span>-<span class="number">3</span>.el7                     docker-<span class="keyword">ce</span>-stable</span><br><span class="line">docker-<span class="keyword">ce</span>.x86_64            <span class="number">18.06</span>.<span class="number">1</span>.<span class="keyword">ce</span>-<span class="number">3</span>.el7                    docker-<span class="keyword">ce</span>-stable</span><br><span class="line">docker-<span class="keyword">ce</span>.x86_64            <span class="number">18.06</span>.<span class="number">0</span>.<span class="keyword">ce</span>-<span class="number">3</span>.el7                    docker-<span class="keyword">ce</span>-stable</span><br><span class="line">docker-<span class="keyword">ce</span>.x86_64            <span class="number">18.03</span>.<span class="number">1</span>.<span class="keyword">ce</span>-<span class="number">1</span>.el7.centos             docker-<span class="keyword">ce</span>-stable</span><br><span class="line">docker-<span class="keyword">ce</span>.x86_64            <span class="number">18.03</span>.<span class="number">0</span>.<span class="keyword">ce</span>-<span class="number">1</span>.el7.centos             docker-<span class="keyword">ce</span>-stable</span><br><span class="line">docker-<span class="keyword">ce</span>.x86_64            <span class="number">17.12</span>.<span class="number">1</span>.<span class="keyword">ce</span>-<span class="number">1</span>.el7.centos             docker-<span class="keyword">ce</span>-stable</span><br><span class="line">docker-<span class="keyword">ce</span>.x86_64            <span class="number">17.12</span>.<span class="number">0</span>.<span class="keyword">ce</span>-<span class="number">1</span>.el7.centos             docker-<span class="keyword">ce</span>-stable</span><br><span class="line">docker-<span class="keyword">ce</span>.x86_64            <span class="number">17.09</span>.<span class="number">1</span>.<span class="keyword">ce</span>-<span class="number">1</span>.el7.centos             docker-<span class="keyword">ce</span>-stable</span><br><span class="line">docker-<span class="keyword">ce</span>.x86_64            <span class="number">17.09</span>.<span class="number">0</span>.<span class="keyword">ce</span>-<span class="number">1</span>.el7.centos             docker-<span class="keyword">ce</span>-stable</span><br><span class="line">docker-<span class="keyword">ce</span>.x86_64            <span class="number">17.06</span>.<span class="number">2</span>.<span class="keyword">ce</span>-<span class="number">1</span>.el7.centos             docker-<span class="keyword">ce</span>-stable</span><br><span class="line">docker-<span class="keyword">ce</span>.x86_64            <span class="number">17.06</span>.<span class="number">1</span>.<span class="keyword">ce</span>-<span class="number">1</span>.el7.centos             docker-<span class="keyword">ce</span>-stable</span><br><span class="line">docker-<span class="keyword">ce</span>.x86_64            <span class="number">17.06</span>.<span class="number">0</span>.<span class="keyword">ce</span>-<span class="number">1</span>.el7.centos             docker-<span class="keyword">ce</span>-stable</span><br><span class="line">docker-<span class="keyword">ce</span>.x86_64            <span class="number">17.03</span>.<span class="number">3</span>.<span class="keyword">ce</span>-<span class="number">1</span>.el7                    docker-<span class="keyword">ce</span>-stable</span><br><span class="line">docker-<span class="keyword">ce</span>.x86_64            <span class="number">17.03</span>.<span class="number">2</span>.<span class="keyword">ce</span>-<span class="number">1</span>.el7.centos             docker-<span class="keyword">ce</span>-stable</span><br><span class="line">docker-<span class="keyword">ce</span>.x86_64            <span class="number">17.03</span>.<span class="number">1</span>.<span class="keyword">ce</span>-<span class="number">1</span>.el7.centos             docker-<span class="keyword">ce</span>-stable</span><br><span class="line">docker-<span class="keyword">ce</span>.x86_64            <span class="number">17.03</span>.<span class="number">0</span>.<span class="keyword">ce</span>-<span class="number">1</span>.el7.centos             docker-<span class="keyword">ce</span>-stable</span><br></pre></td></tr></table></figure></p>
<p> Kubernetes 1.12已经针对Docker的1.11.1, 1.12.1, 1.13.1, 17.03, 17.06, 17.09, 18.06等版本做了验证，需要注意Kubernetes 1.12最低支持的Docker版本是1.11.1。Kubernetes 1.13对Docker的版本依赖方面没有变化。 我们这里在各节点安装docker的18.06.1版本。</p>
 <figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">yum makecache fast</span><br><span class="line"></span><br><span class="line">yum install -y --setopt=obsoletes=<span class="number">0</span> \</span><br><span class="line">  docker-ce<span class="number">-18.06</span><span class="number">.1</span>.ce<span class="number">-3.</span>el7</span><br><span class="line"></span><br><span class="line">systemctl start docker</span><br><span class="line">systemctl enable docker</span><br></pre></td></tr></table></figure>
<p> 确认一下iptables filter表中FOWARD链的默认策略(pllicy)为ACCEPT。<br> <figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">iptables -nvL</span><br><span class="line">Chain INPUT (policy ACCEPT <span class="number">263</span> packets, <span class="number">19209</span> bytes)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination</span><br><span class="line"></span><br><span class="line">Chain FORWARD (policy ACCEPT <span class="number">0</span> packets, <span class="number">0</span> bytes)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination</span><br><span class="line">    <span class="number">0</span>     <span class="number">0</span> DOCKER-USER  all  --  *      *       <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">0</span>            <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">0</span></span><br><span class="line">    <span class="number">0</span>     <span class="number">0</span> DOCKER-ISOLATION-STAGE<span class="number">-1</span>  all  --  *      *       <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">0</span>            <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">0</span></span><br><span class="line">    <span class="number">0</span>     <span class="number">0</span> ACCEPT     all  --  *      docker0  <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">0</span>            <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">0</span>            ctstate RELATED,ESTABLISHED</span><br><span class="line">    <span class="number">0</span>     <span class="number">0</span> DOCKER     all  --  *      docker0  <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">0</span>            <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">0</span></span><br><span class="line">    <span class="number">0</span>     <span class="number">0</span> ACCEPT     all  --  docker0 !docker0  <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">0</span>            <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">0</span></span><br><span class="line">    <span class="number">0</span>     <span class="number">0</span> ACCEPT     all  --  docker0 docker0  <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">0</span>            <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">0</span></span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>Docker从1.13版本开始调整了默认的防火墙规则，禁用了iptables filter表中FOWARD链，这样会引起Kubernetes集群中跨Node的Pod无法通信。但这里通过安装docker 1806，发现默认策略又改回了ACCEPT，这个不知道是从哪个版本改回的，因为我们线上版本使用的1706还是需要手动调整这个策略的。</p>
</blockquote>
<h1 id="2-使用kubeadm部署Kubernetes"><a href="#2-使用kubeadm部署Kubernetes" class="headerlink" title="2. 使用kubeadm部署Kubernetes"></a>2. 使用kubeadm部署Kubernetes</h1><h3 id="2-1-安装kubeadm和kubelet"><a href="#2-1-安装kubeadm和kubelet" class="headerlink" title="2.1 安装kubeadm和kubelet"></a>2.1 安装kubeadm和kubelet</h3><p>  下面在各节点安装kubeadm和kubelet：<br> <figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo</span><br><span class="line">[kubernetes]</span><br><span class="line">name=Kubernetes</span><br><span class="line">baseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-x86_64</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=1</span><br><span class="line">repo_gpgcheck=1</span><br><span class="line">gpgkey=https://packages.cloud.google.com/yum/doc/yum-key.gpg</span><br><span class="line">        https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></p>
<p> 测试地址<a href="https://packages.cloud.google.com/yum/repos/kubernetes-el7-x86_64是否可用，如果不可用需要科学上网。" target="_blank" rel="noopener">https://packages.cloud.google.com/yum/repos/kubernetes-el7-x86_64是否可用，如果不可用需要科学上网。</a><br> <figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl https:<span class="regexp">//</span>packages.cloud.google.com<span class="regexp">/yum/</span>repos<span class="regexp">/kubernetes-el7-x86_64</span></span><br></pre></td></tr></table></figure></p>
 <figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">yum</span> <span class="selector-tag">makecache</span> <span class="selector-tag">fast</span></span><br><span class="line"><span class="selector-tag">yum</span> <span class="selector-tag">install</span> <span class="selector-tag">-y</span> <span class="selector-tag">kubelet</span> <span class="selector-tag">kubeadm</span> <span class="selector-tag">kubectl</span> <span class="selector-tag">ipvsadm</span> <span class="selector-tag">ipset</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="selector-tag">Installed</span>:</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">socat-1</span><span class="selector-class">.7</span><span class="selector-class">.3</span><span class="selector-class">.2-2</span><span class="selector-class">.el7</span><span class="selector-class">.x86_64</span>               </span><br><span class="line"><span class="selector-tag">libnetfilter_queue-1</span><span class="selector-class">.0</span><span class="selector-class">.2-2</span><span class="selector-class">.el7_2</span><span class="selector-class">.x86_64</span>  </span><br><span class="line"><span class="selector-tag">libnetfilter_cttimeout-1</span><span class="selector-class">.0</span><span class="selector-class">.0-6</span><span class="selector-class">.el7</span><span class="selector-class">.x86_64</span></span><br><span class="line"><span class="selector-tag">kubectl-1</span><span class="selector-class">.14</span><span class="selector-class">.1-0</span><span class="selector-class">.x86_64</span>                  </span><br><span class="line"><span class="selector-tag">libnetfilter_cthelper-1</span><span class="selector-class">.0</span><span class="selector-class">.0-9</span><span class="selector-class">.el7</span><span class="selector-class">.x86_64</span> </span><br><span class="line"><span class="selector-tag">conntrack-tools-1</span><span class="selector-class">.4</span><span class="selector-class">.4-4</span><span class="selector-class">.el7</span><span class="selector-class">.x86_64</span>       </span><br><span class="line"><span class="selector-tag">kubernetes-cni-0</span><span class="selector-class">.7</span><span class="selector-class">.5-0</span><span class="selector-class">.x86_64</span>            </span><br><span class="line"><span class="selector-tag">kubelet-1</span><span class="selector-class">.14</span><span class="selector-class">.1-0</span><span class="selector-class">.x86_64</span>                  </span><br><span class="line"><span class="selector-tag">cri-tools-1</span><span class="selector-class">.12</span><span class="selector-class">.0-0</span><span class="selector-class">.x86_64</span>                </span><br><span class="line"><span class="selector-tag">kubeadm-1</span><span class="selector-class">.14</span><span class="selector-class">.1-0</span><span class="selector-class">.x86_64</span></span><br><span class="line"><span class="selector-tag">ipvsadm</span><span class="selector-class">.x86_64</span> 0<span class="selector-pseudo">:1.27-7.el7</span></span><br><span class="line"><span class="selector-tag">ipset-6</span><span class="selector-class">.38-3</span><span class="selector-class">.el7_6</span><span class="selector-class">.x86_64</span></span><br></pre></td></tr></table></figure>
<p> 关闭系统的Swap方法如下:<br> <figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">swapoff -a</span></span><br></pre></td></tr></table></figure></p>
<p> 修改 /etc/fstab 文件，注释掉 SWAP 的自动挂载，使用free -m确认swap已经关闭。 swappiness参数调整，修改/etc/sysctl.d/k8s.conf添加下面一行：<br> <figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">vm.swappiness</span>=<span class="number">0</span></span><br></pre></td></tr></table></figure></p>
<p> 执行<br> <figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sysctl -<span class="selector-tag">p</span> /etc/sysctl.d/k8s.conf</span><br><span class="line"></span><br><span class="line">使修改生效。</span><br></pre></td></tr></table></figure></p>
<hr>
<p> 因为这里本次用于测试两台主机上还运行其他服务，关闭swap可能会对其他服务产生影响，所以这里修改kubelet的配置去掉这个限制。 之前的Kubernetes版本我们都是通过kubelet的启动参数–fail-swap-on=false去掉这个限制的。前面已经分析了Kubernetes不再推荐使用启动参数，而推荐使用配置文件。 所以这里我们改成配置文件配置的形式。</p>
<p> 查看/etc/systemd/system/kubelet.service.d/10-kubeadm.conf，看到了下面的内容：</p>
 <figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># <span class="doctag">Note:</span> This dropin only works with kubeadm and kubelet v1.11+</span></span><br><span class="line"><span class="section">[Service]</span></span><br><span class="line"><span class="attr">Environment</span>=<span class="string">"KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf"</span></span><br><span class="line"><span class="attr">Environment</span>=<span class="string">"KUBELET_CONFIG_ARGS=--config=/var/lib/kubelet/config.yaml"</span></span><br><span class="line"><span class="comment"># This is a file that "kubeadm init" and "kubeadm join" generates at runtime, populating the KUBELET_KUBEADM_ARGS variable dynamically</span></span><br><span class="line"><span class="attr">EnvironmentFile</span>=-/var/lib/kubelet/kubeadm-flags.env</span><br><span class="line"><span class="comment"># This is a file that the user can use for overrides of the kubelet args as a last resort. Preferably, the user should use</span></span><br><span class="line"><span class="comment"># the .NodeRegistration.KubeletExtraArgs object in the configuration files instead. KUBELET_EXTRA_ARGS should be sourced from this file.</span></span><br><span class="line"><span class="attr">EnvironmentFile</span>=-/etc/sysconfig/kubelet</span><br><span class="line"><span class="attr">ExecStart</span>=</span><br><span class="line"><span class="attr">ExecStart</span>=/usr/bin/kubelet <span class="variable">$KUBELET_KUBECONFIG_ARGS</span> <span class="variable">$KUBELET_CONFIG_ARGS</span> <span class="variable">$KUBELET_KUBEADM_ARGS</span> <span class="variable">$KUBELET_EXTRA_ARGS</span></span><br></pre></td></tr></table></figure>
<p> 上面显示kubeadm部署的kubelet的配置文件–config=/var/lib/kubelet/config.yaml，实际去查看/var/lib/kubelet和这个config.yaml的配置文件都没有被创建。 可以猜想肯定是运行kubeadm初始化集群时会自动生成这个配置文件，而如果我们不关闭Swap的话，第一次初始化集群肯定会失败的。</p>
<p> 所以还是老老实实的回到使用kubelet的启动参数–fail-swap-on=false去掉必须关闭Swap的限制。 修改/etc/sysconfig/kubelet，加入：<br> <figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">KUBELET_EXTRA_ARGS</span>=--fail-swap-<span class="literal">on</span>=<span class="literal">false</span></span><br></pre></td></tr></table></figure></p>
<h3 id="配置keepalived和Haproxy"><a href="#配置keepalived和Haproxy" class="headerlink" title="配置keepalived和Haproxy"></a>配置keepalived和Haproxy</h3><ul>
<li><p>在lbs1和lbs2节点配置keepalived和haproxy, lbs1为MASTER,  lbs2为BACKUP ls1, ls2 配置文件相同</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum <span class="keyword">install</span> -y keepalived haproxy</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置lbs1节点上的keepalived</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt; <span class="literal">EOF</span> | tee /etc/keepalived/keepalived.conf</span><br><span class="line">! Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   notification_email &#123;</span><br><span class="line">      root@localhost</span><br><span class="line">   &#125;</span><br><span class="line">   notification_email_from keepalived@localhost</span><br><span class="line">   smtp_server <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">   smtp_connect_timeout <span class="number">30</span></span><br><span class="line">   router_id kh01</span><br><span class="line">   vrrp_mcast_group4 <span class="number">224.0</span><span class="number">.100</span><span class="number">.100</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    <span class="section">state</span> MASTER</span><br><span class="line">    interface ens192</span><br><span class="line">    virtual_router_id <span class="number">51</span></span><br><span class="line">    priority <span class="number">100</span></span><br><span class="line">    advert_int <span class="number">1</span></span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass <span class="number">0</span>d25bedd3b13081c5ba5</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        <span class="number">10.122</span><span class="number">.144</span><span class="number">.152</span>/<span class="number">16</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="literal">EOF</span></span><br><span class="line"></span><br><span class="line">systemctl enable keepalived</span><br><span class="line">systemctl start keepalived</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置lbs1节点上的haproxy</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt; EOF | tee /etc/haproxy/haproxy.cfg</span><br><span class="line">global</span><br><span class="line">    log         127.0.0.1 local2</span><br><span class="line">    chroot      /var/lib/haproxy</span><br><span class="line">    pidfile     /var/run/haproxy.pid</span><br><span class="line">    maxconn     4000</span><br><span class="line">   <span class="built_in"> user </span>       haproxy</span><br><span class="line">   <span class="built_in"> group </span>      haproxy</span><br><span class="line">    daemon</span><br><span class="line"></span><br><span class="line">defaults</span><br><span class="line">    mode                    tcp</span><br><span class="line">    log                     global</span><br><span class="line">    retries                 3</span><br><span class="line">    timeout connect         10s</span><br><span class="line">    timeout<span class="built_in"> client </span>         1m</span><br><span class="line">    timeout<span class="built_in"> server </span>         1m</span><br><span class="line"></span><br><span class="line">frontend kubernetes</span><br><span class="line">    bind *:6443</span><br><span class="line">    mode tcp</span><br><span class="line">    default_backend kubernetes-master</span><br><span class="line"></span><br><span class="line">backend kubernetes-master</span><br><span class="line">    balance roundrobin</span><br><span class="line">   <span class="built_in"> server </span>master  10.122.144.153:6443 check maxconn 2000</span><br><span class="line">   <span class="built_in"> server </span>master2 10.122.144.153:6443 check maxconn 2000</span><br><span class="line">   <span class="built_in"> server </span>master3 10.122.144.153:6443 check maxconn 2000</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">systemctl <span class="builtin-name">enable</span> haproxy</span><br><span class="line">systemctl start haproxy</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="修改-kubeadm-配置信息"><a href="#修改-kubeadm-配置信息" class="headerlink" title="修改 kubeadm 配置信息"></a>修改 kubeadm 配置信息</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">导出 配置 信息</span><br><span class="line">kubeadm config print init-defaults &gt; kubeadm-init.yaml</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"># 修改相关配置 ，本文配置信息如下</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">apiVersion: kubeadm.k8s.io/v1beta1</span><br><span class="line">bootstrapTokens:</span><br><span class="line">- groups:</span><br><span class="line">  - system:bootstrappers:kubeadm:default-node-token</span><br><span class="line">  token: abcdef.0123456789abcdef</span><br><span class="line">  ttl: 24h0m0s</span><br><span class="line">  usages:</span><br><span class="line">  - signing</span><br><span class="line">  - authentication</span><br><span class="line">kind: InitConfiguration</span><br><span class="line">localAPIEndpoint:</span><br><span class="line">  advertiseAddress: 127.0.0.1</span><br><span class="line">  bindPort: 6443</span><br><span class="line">nodeRegistration:</span><br><span class="line">  criSocket: /var/run/dockershim.sock</span><br><span class="line">  name: kubernetes-1</span><br><span class="line">  taints:</span><br><span class="line">  - effect: NoSchedule</span><br><span class="line">    key: node-role.kubernetes.io/master</span><br><span class="line">---</span><br><span class="line">apiServer:</span><br><span class="line">  timeoutForControlPlane: 4m0s</span><br><span class="line">apiVersion: kubeadm.k8s.io/v1beta1</span><br><span class="line">certificatesDir: /etc/kubernetes/pki</span><br><span class="line">clusterName: kubernetes</span><br><span class="line">controlPlaneEndpoint: &quot;10.122.144.152:6443&quot;</span><br><span class="line">controllerManager: &#123;&#125;</span><br><span class="line">dns:</span><br><span class="line">  type: CoreDNS</span><br><span class="line">etcd:</span><br><span class="line">  local:</span><br><span class="line">    dataDir: /var/lib/etcd</span><br><span class="line">imageRepository: registry.gcr.io/google_containers</span><br><span class="line">kind: ClusterConfiguration</span><br><span class="line">kubernetesVersion: v1.15.0</span><br><span class="line">networking:</span><br><span class="line">  dnsDomain: cluster.local</span><br><span class="line">  podSubnet: &quot;10.254.64.0/18&quot;</span><br><span class="line">  serviceSubnet: &quot;10.254.0.0/18&quot;</span><br><span class="line">scheduler: &#123;&#125;</span><br><span class="line">---</span><br><span class="line">apiVersion: kubeproxy.config.k8s.io/v1alpha1</span><br><span class="line">kind: KubeProxyConfiguration</span><br><span class="line">mode: &quot;ipvs&quot;</span><br></pre></td></tr></table></figure>
<h3 id="3-4-初始化集群"><a href="#3-4-初始化集群" class="headerlink" title="3.4 初始化集群"></a>3.4 初始化集群</h3><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">kubeadm</span> <span class="comment">init</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">config=kubeadm</span><span class="literal">-</span><span class="comment">config</span><span class="string">.</span><span class="comment">yaml</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">upload</span><span class="literal">-</span><span class="comment">certs</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">该</span><span class="literal">-</span><span class="literal">-</span><span class="comment">upload</span><span class="literal">-</span><span class="comment">certs标志用于将应在所有控制平面实例之间共享的证书上载到群集。相反，如果您希望手动或使用自动化工具跨控制平面节点复制证书，请删除此标志并参考下面的手动证书分发部分。</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[bootstrap-token] creating the "cluster-info" ConfigMap in the "kube-public" namespace</span><br><span class="line">[addons] Applied essential addon: CoreDNS</span><br><span class="line">[addons] Applied essential addon: kube-proxy</span><br><span class="line"></span><br><span class="line">Your Kubernetes control-plane has initialized successfully!</span><br><span class="line"></span><br><span class="line">To <span class="keyword">start</span> <span class="keyword">using</span> your cluster, you need <span class="keyword">to</span> run the <span class="keyword">following</span> <span class="keyword">as</span> a regular <span class="keyword">user</span>:</span><br><span class="line"></span><br><span class="line">  mkdir -p $HOME/.kube</span><br><span class="line">  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span><br><span class="line">  sudo chown $(<span class="keyword">id</span> -u):$(<span class="keyword">id</span> -g) $HOME/.kube/config</span><br><span class="line"></span><br><span class="line">You should <span class="keyword">now</span> deploy a pod network <span class="keyword">to</span> the cluster.</span><br><span class="line">Run <span class="string">"kubectl apply -f [podnetwork].yaml"</span> <span class="keyword">with</span> one <span class="keyword">of</span> the options listed <span class="keyword">at</span>:</span><br><span class="line">  https://kubernetes.io/docs/concepts/cluster-administration/addons/</span><br><span class="line"></span><br><span class="line">You can <span class="keyword">now</span> <span class="keyword">join</span> <span class="keyword">any</span> <span class="built_in">number</span> <span class="keyword">of</span> control-plane nodes <span class="keyword">by</span> copying certificate authorities </span><br><span class="line"><span class="keyword">and</span> service <span class="keyword">account</span> <span class="keyword">keys</span> <span class="keyword">on</span> <span class="keyword">each</span> node <span class="keyword">and</span> <span class="keyword">then</span> running the <span class="keyword">following</span> <span class="keyword">as</span> root:</span><br><span class="line"></span><br><span class="line">  kubeadm <span class="keyword">join</span> <span class="number">10.122</span><span class="number">.144</span><span class="number">.152</span>:<span class="number">6443</span> <span class="comment">--token abcdef.0123456789abcdef \</span></span><br><span class="line">    <span class="comment">--discovery-token-ca-cert-hash sha256:5dff9a228bf55f1e8a6a754f3c087017247734b06c24138c0474d448d8aa5569 \</span></span><br><span class="line">    <span class="comment">--experimental-control-plane          </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">Then</span> you can <span class="keyword">join</span> <span class="keyword">any</span> <span class="built_in">number</span> <span class="keyword">of</span> worker nodes <span class="keyword">by</span> running the <span class="keyword">following</span> <span class="keyword">on</span> <span class="keyword">each</span> <span class="keyword">as</span> root:</span><br><span class="line"></span><br><span class="line">kubeadm <span class="keyword">join</span> <span class="number">10.122</span><span class="number">.144</span><span class="number">.152</span>:<span class="number">6443</span> <span class="comment">--token abcdef.0123456789abcdef \</span></span><br><span class="line">    <span class="comment">--discovery-token-ca-cert-hash sha256:5dff9a228bf55f1e8a6a754f3c087017247734b06c24138c0474d448d8aa5569</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p $HOME/.kube</span><br><span class="line">cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span><br><span class="line">chown $(id -u):$(id -g) $HOME/.kube/config</span><br></pre></td></tr></table></figure>
<h4 id="查看集群状态"><a href="#查看集群状态" class="headerlink" title="查看集群状态"></a>查看集群状态</h4><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@kubernetes-1 ~]# kubectl <span class="builtin-name">get</span> cs</span><br><span class="line">NAME                 STATUS    MESSAGE             ERROR</span><br><span class="line">controller-manager   Healthy   ok                  </span><br><span class="line">scheduler            Healthy   ok                  </span><br><span class="line">etcd-0               Healthy   &#123;<span class="string">"health"</span>:<span class="string">"true"</span>&#125;</span><br></pre></td></tr></table></figure>
<h3 id="其余控制平面节点的步骤"><a href="#其余控制平面节点的步骤" class="headerlink" title="其余控制平面节点的步骤"></a>其余控制平面节点的步骤</h3><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">kubeadm</span> <span class="selector-tag">join</span> 10<span class="selector-class">.122</span><span class="selector-class">.144</span><span class="selector-class">.152</span><span class="selector-pseudo">:6443</span> <span class="selector-tag">--token</span> <span class="selector-tag">abcdef</span><span class="selector-class">.0123456789abcdef</span> \</span><br><span class="line">    <span class="selector-tag">--discovery-token-ca-cert-hash</span> <span class="selector-tag">sha256</span><span class="selector-pseudo">:5dff9a228bf55f1e8a6a754f3c087017247734b06c24138c0474d448d8aa5569</span> \</span><br><span class="line">    <span class="selector-tag">--experimental-control-plane</span></span><br></pre></td></tr></table></figure>
<h3 id="加入工作节点"><a href="#加入工作节点" class="headerlink" title="加入工作节点"></a>加入工作节点</h3><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">kubeadm join <span class="number">10.122</span><span class="number">.144</span><span class="number">.152</span>:<span class="number">6443</span> <span class="comment">--token abcdef.0123456789abcdef \</span></span><br><span class="line">    <span class="comment">--discovery-token-ca-cert-hash sha256:5dff9a228bf55f1e8a6a754f3c087017247734b06c24138c0474d448d8aa5569</span></span><br><span class="line"></span><br><span class="line">输出如下:</span><br><span class="line"></span><br><span class="line">This node has joined <span class="keyword">the</span> cluster:</span><br><span class="line">* Certificate signing request was sent <span class="built_in">to</span> apiserver <span class="keyword">and</span> <span class="keyword">a</span> response was received.</span><br><span class="line">* The Kubelet was informed <span class="keyword">of</span> <span class="keyword">the</span> <span class="built_in">new</span> secure connection details.</span><br><span class="line"></span><br><span class="line">Run <span class="string">'kubectl get nodes'</span> <span class="keyword">on</span> <span class="title">the</span> <span class="title">control-plane</span> <span class="title">to</span> <span class="title">see</span> <span class="title">this</span> <span class="title">node</span> <span class="title">join</span> <span class="title">the</span> <span class="title">cluster</span>.</span><br></pre></td></tr></table></figure>
<h3 id="验证节点"><a href="#验证节点" class="headerlink" title="验证节点"></a>验证节点</h3><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@kubernetes<span class="number">-1</span> ~]# kubectl get nodes</span><br><span class="line">NAME           STATUS     ROLES    AGE     VERSION</span><br><span class="line">kubernetes<span class="number">-1</span>   NotReady   master   <span class="number">13</span>m     v1<span class="number">.15</span><span class="number">.0</span></span><br><span class="line">kubernetes<span class="number">-2</span>   NotReady   master   <span class="number">8</span>m20s   v1<span class="number">.15</span><span class="number">.0</span></span><br><span class="line">kubernetes<span class="number">-3</span>   NotReady   master   <span class="number">5</span>m21s   v1<span class="number">.15</span><span class="number">.0</span></span><br><span class="line">kubernetes<span class="number">-4</span>   NotReady   &lt;none&gt;   <span class="number">45</span>s     v1<span class="number">.15</span><span class="number">.0</span></span><br><span class="line">kubernetes<span class="number">-5</span>   NotReady   &lt;none&gt;   <span class="number">39</span>s     v1<span class="number">.15</span><span class="number">.0</span></span><br></pre></td></tr></table></figure>
<h3 id="3-7-安装网络组件"><a href="#3-7-安装网络组件" class="headerlink" title="3.7 安装网络组件"></a>3.7 安装网络组件</h3><p>   Calico 网络</p>
<pre><code>官方文档 https://docs.projectcalico.org/v3.7/introduction
</code></pre><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">下载 yaml 文件</span><br><span class="line"></span><br><span class="line">wget <span class="string">https:</span><span class="comment">//docs.projectcalico.org/v3.7/manifests/calico.yaml</span></span><br><span class="line"></span><br><span class="line">vi calico.yaml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">修改 pods 分配的 IP 段</span><br><span class="line">            - <span class="string">name:</span> CALICO_IPV4POOL_CIDR</span><br><span class="line"><span class="symbol">              value:</span> <span class="string">"10.254.64.0/18"</span></span><br></pre></td></tr></table></figure>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 导入 yaml 文件</span></span><br><span class="line"></span><br><span class="line">[root@kubernetes-<span class="number">1</span> calico]<span class="comment"># kubectl apply -f calico.yaml </span></span><br><span class="line">configmap/calico-config created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/felixconfigurations.crd.projectcalico.org created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/ipamblocks.crd.projectcalico.org created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/blockaffinities.crd.projectcalico.org created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/ipamhandles.crd.projectcalico.org created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/ipamconfigs.crd.projectcalico.org created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/bgppeers.crd.projectcalico.org created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/bgpconfigurations.crd.projectcalico.org created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/ippools.crd.projectcalico.org created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/hostendpoints.crd.projectcalico.org created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/cluster<span class="literal">inf</span>ormations.crd.projectcalico.org created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/globalnetworkpolicies.crd.projectcalico.org created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/globalnetworksets.crd.projectcalico.org created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/networkpolicies.crd.projectcalico.org created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/networksets.crd.projectcalico.org created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/calico-kube-controllers created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/calico-kube-controllers created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/calico-<span class="keyword">node</span> <span class="title">created</span></span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/calico-<span class="keyword">node</span> <span class="title">created</span></span><br><span class="line">daemonset.extensions/calico-<span class="keyword">node</span> <span class="title">created</span></span><br><span class="line">serviceaccount/calico-<span class="keyword">node</span> <span class="title">created</span></span><br><span class="line">deployment.extensions/calico-kube-controllers created</span><br><span class="line">serviceaccount/calico-kube-controllers created</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看服务</span></span><br><span class="line"></span><br><span class="line">[root@kubernetes-<span class="number">1</span> calico]<span class="comment"># kubectl get pods -n kube-system |grep calico</span></span><br><span class="line">calico-kube-controllers-<span class="number">8646</span>dd497f-<span class="number">4</span>d4hr   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">28s</span></span><br><span class="line">calico-<span class="keyword">node</span><span class="title">-455mf</span>                          <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">28s</span></span><br><span class="line">calico-<span class="keyword">node</span><span class="title">-b8mrr</span>                          <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">28s</span></span><br><span class="line">calico-<span class="keyword">node</span><span class="title">-fq9dj</span>                          <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">28s</span></span><br><span class="line">calico-<span class="keyword">node</span><span class="title">-sk77j</span>                          <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">28s</span></span><br><span class="line">calico-<span class="keyword">node</span><span class="title">-xxnb8</span>                          <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">28s</span></span><br></pre></td></tr></table></figure>
<h3 id="检验整体集群"><a href="#检验整体集群" class="headerlink" title="检验整体集群"></a>检验整体集群</h3><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@kubernetes<span class="number">-1</span> ~]# kubectl get nodes</span><br><span class="line">NAME           STATUS     ROLES    AGE     VERSION</span><br><span class="line">kubernetes<span class="number">-1</span>   NotReady   master   <span class="number">13</span>m     v1<span class="number">.15</span><span class="number">.0</span></span><br><span class="line">kubernetes<span class="number">-2</span>   NotReady   master   <span class="number">8</span>m20s   v1<span class="number">.15</span><span class="number">.0</span></span><br><span class="line">kubernetes<span class="number">-3</span>   NotReady   master   <span class="number">5</span>m21s   v1<span class="number">.15</span><span class="number">.0</span></span><br><span class="line">kubernetes<span class="number">-4</span>   NotReady   &lt;none&gt;   <span class="number">45</span>s     v1<span class="number">.15</span><span class="number">.0</span></span><br><span class="line">kubernetes<span class="number">-5</span>   NotReady   &lt;none&gt;   <span class="number">39</span>s     v1<span class="number">.15</span><span class="number">.0</span></span><br></pre></td></tr></table></figure>
<h3 id="查看-pods-状态"><a href="#查看-pods-状态" class="headerlink" title="查看 pods 状态"></a>查看 pods 状态</h3><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@kubernetes<span class="number">-1</span> ~]# kubectl get pods --all-namespaces</span><br><span class="line">NAMESPACE     NAME                                       READY   STATUS    RESTARTS   AGE</span><br><span class="line">kube-system   calico-kube-controllers<span class="number">-8646</span>dd497f<span class="number">-4</span>d4hr   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">3</span>m33s</span><br><span class="line">kube-system   calico-node<span class="number">-455</span>mf                          <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">3</span>m33s</span><br><span class="line">kube-system   calico-node-b8mrr                          <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">3</span>m33s</span><br><span class="line">kube-system   calico-node-fq9dj                          <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">3</span>m33s</span><br><span class="line">kube-system   calico-node-sk77j                          <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">3</span>m33s</span><br><span class="line">kube-system   calico-node-xxnb8                          <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">3</span>m33s</span><br><span class="line">kube-system   coredns-d5947d4b-q4pst                     <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">35</span>m</span><br><span class="line">kube-system   coredns-d5947d4b-sz2bm                     <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">35</span>m</span><br><span class="line">kube-system   etcd-kubernetes<span class="number">-1</span>                          <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">34</span>m</span><br><span class="line">kube-system   etcd-kubernetes<span class="number">-2</span>                          <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">30</span>m</span><br><span class="line">kube-system   etcd-kubernetes<span class="number">-3</span>                          <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">27</span>m</span><br><span class="line">kube-system   kube-apiserver-kubernetes<span class="number">-1</span>                <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">35</span>m</span><br><span class="line">kube-system   kube-apiserver-kubernetes<span class="number">-2</span>                <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">30</span>m</span><br><span class="line">kube-system   kube-apiserver-kubernetes<span class="number">-3</span>                <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">26</span>m</span><br><span class="line">kube-system   kube-controller-manager-kubernetes<span class="number">-1</span>       <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">1</span>          <span class="number">34</span>m</span><br><span class="line">kube-system   kube-controller-manager-kubernetes<span class="number">-2</span>       <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">30</span>m</span><br><span class="line">kube-system   kube-controller-manager-kubernetes<span class="number">-3</span>       <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">26</span>m</span><br><span class="line">kube-system   kube-proxy<span class="number">-2</span>ht7m                           <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">35</span>m</span><br><span class="line">kube-system   kube-proxy-bkg7z                           <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">22</span>m</span><br><span class="line">kube-system   kube-proxy-sdxnj                           <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">23</span>m</span><br><span class="line">kube-system   kube-proxy-tpc4x                           <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">27</span>m</span><br><span class="line">kube-system   kube-proxy-wvllx                           <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">30</span>m</span><br><span class="line">kube-system   kube-scheduler-kubernetes<span class="number">-1</span>                <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">1</span>          <span class="number">35</span>m</span><br><span class="line">kube-system   kube-scheduler-kubernetes<span class="number">-2</span>                <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">30</span>m</span><br><span class="line">kube-system   kube-scheduler-kubernetes<span class="number">-3</span>                <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">26</span>m</span><br></pre></td></tr></table></figure>
<h3 id="查看-IPVS-的状态"><a href="#查看-IPVS-的状态" class="headerlink" title="查看 IPVS 的状态"></a>查看 IPVS 的状态</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">root@kubernetes-1 ~]# ipvsadm -L -n</span><br><span class="line"></span><br><span class="line">IP Virtual<span class="built_in"> Server </span>version 1.2.1 (<span class="attribute">size</span>=4096)</span><br><span class="line">Prot LocalAddress:Port<span class="built_in"> Scheduler </span>Flags</span><br><span class="line">  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn</span><br><span class="line">TCP  10.254.0.1:443 rr</span><br><span class="line">  -&gt; 192.168.168.11:6443          Masq    1      2          0         </span><br><span class="line">  -&gt; 192.168.168.12:6443          Masq    1      0          0         </span><br><span class="line">  -&gt; 192.168.168.13:6443          Masq    1      1          0         </span><br><span class="line">TCP  10.254.0.10:53 rr</span><br><span class="line">  -&gt; 10.254.91.66:53              Masq    1      0          0         </span><br><span class="line">  -&gt; 10.254.105.65:53             Masq    1      0          0         </span><br><span class="line">TCP  10.254.0.10:9153 rr</span><br><span class="line">  -&gt; 10.254.91.66:9153            Masq    1      0          0         </span><br><span class="line">  -&gt; 10.254.105.65:9153           Masq    1      0          0         </span><br><span class="line">UDP  10.254.0.10:53 rr</span><br><span class="line">  -&gt; 10.254.91.66:53              Masq    1      0          0         </span><br><span class="line">  -&gt; 10.254.105.65:53             Masq    1      0          0</span><br></pre></td></tr></table></figure>
</div></header><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a class="post__tag__link" href="/tags/kubernetes/">kubernetes</a></li><li class="post__tag__item"><a class="post__tag__link" href="/tags/kubeadm/">kubeadm</a></li><li class="post__tag__item"><a class="post__tag__link" href="/tags/centos7/">centos7</a></li><li class="post__tag__item"><a class="post__tag__link" href="/tags/Haproxy/">Haproxy</a></li><li class="post__tag__item"><a class="post__tag__link" href="/tags/keepalived/">keepalived</a></li><li class="post__tag__item"><a class="post__tag__link" href="/tags/scope/">scope</a></li></ul></footer></article><section class="reward"><a class="btn-reward" href="#">打赏</a><div class="reward-wrapper clearfix"><img src="/img/wechat20.png" title="微信"></div></section></main><footer class="foot"><div class="foot-copy">&copy; 2016 - 2021 Willie Lin</div></footer><script src="/js/scroller.js"></script><script src="/js/main.js"></script></body></html>