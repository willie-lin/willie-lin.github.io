<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="author" content="Willie Lin"><link rel="alternative" href="/atom.xml" title="Willie Lin" type="application/atom+xml"><link rel="icon" href="/favicon.png"><title>使用kubeadm升级kubernetes集群 - Willie Lin</title><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/js/fancybox/jquery.fancybox.min.css"><!--[if lt IE 9]><script>(function(a,b){a="abbr article aside audio bdi canvas data datalist details dialog figcaption figure footer header hgroup main mark meter nav output progress section summary template time video".split(" ");for(b=a.length-1;b>=0;b--)document.createElement(a[b])})()</script><![endif]--><script src="/js/jquery-3.1.1.min.js"></script><script src="/js/fancybox/jquery.fancybox.min.js"></script></head><body style="opacity:0"><header class="head"><h1 class="head-title u-fl"><a href="/">Willie Lin</a></h1><nav class="head-nav u-fr"><ul class="head-nav__list"><li class="head-nav__item"><a class="head-nav__link" href="/archives">カタログ/（目录）</a></li></ul></nav></header><main class="main"><article class="post"><header class="post__head"><time class="post__time" datetime="2020-03-27T12:03:09.000Z">2020 - 03 - 27 20:03:09</time><h1 class="post__title"><a href="/2020/03/27/使用kubeadm升级kubernetes集群/">使用kubeadm升级kubernetes集群</a></h1><div class="post__main echo"><h3 id="在你开始之前"><a href="#在你开始之前" class="headerlink" title="在你开始之前"></a>在你开始之前</h3><blockquote>
<ul>
<li>您需要具有运行版本1.17.0或更高版本的kubeadm Kubernetes集群。</li>
<li>必须禁用掉期交易。</li>
<li>集群应使用静态控制平面和etcd pod或外部etcd。</li>
<li>确保您仔细阅读发行说明。</li>
<li>确保备份所有重要组件，例如存储在数据库中的应用程序级别状态。 kubeadm upgrade不会影响您的工作负载，仅涉及Kubernetes内部的组件，但是备份始终是最佳实践。</li>
<li>附加信息升级后，所有容器都会重新启动，因为容器规范哈希值已更改。您只能从一个MINOR版本升级到下一个MINOR版本，或者在同一MINOR的PATCH版本之间升级。也就是说，升级时不能跳过MINOR版本。例如，您可以从1.y升级到1.y + 1，但不能从1.y升级到1.y + 2。</li>
</ul>
</blockquote>
<h4 id="确定要升级到的版本"><a href="#确定要升级到的版本" class="headerlink" title="确定要升级到的版本"></a>确定要升级到的版本</h4><blockquote>
<p>查找最新的稳定的1.17版本：Ubuntu，Debian或HypriotOSCentOS，RHEL或Fedora<br>apt update<br>apt-cache madison kubeadm</p>
</blockquote>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">升级控制平面节点</span><br><span class="line">升级第一个控制平面节点</span><br><span class="line">在您的第一个控制平面节点上，升级kubeadm：</span><br><span class="line">RHEL或Fedora</span><br><span class="line"># replace x in <span class="number">1.18</span>.x<span class="number">-0</span> with the latest patch version</span><br><span class="line">yum install -y kubeadm<span class="number">-1.18</span>.x<span class="number">-0</span> --disableexcludes=kubernetes</span><br></pre></td></tr></table></figure>
<blockquote>
<p>确认下载正常并且具有预期的版本：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm version</span><br></pre></td></tr></table></figure></p>
</blockquote>
<p>kubeadm version</p>
<blockquote>
<p>排空控制平面节点：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"># replace &lt;cp-node-name&gt; with the name of your control plane node</span><br><span class="line">kubectl drain &lt;cp-node-name&gt; --ignore-daemonsets</span><br></pre></td></tr></table></figure></p>
</blockquote>
<blockquote>
<p>在控制平面节点上，运行：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo kubeadm<span class="built_in"> upgrade </span>plan</span><br></pre></td></tr></table></figure></p>
</blockquote>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">您应该看到类似于以下的输出：</span><br><span class="line">[upgrade/config] Making sure the configuration is correct:</span><br><span class="line">[upgrade/config] Reading configuration from the cluster...</span><br><span class="line">[upgrade/config] FYI: You can look <span class="meta">at</span> this config file with <span class="string">'kubectl -n kube-system get cm kubeadm-config -oyaml'</span></span><br><span class="line">[preflight] Running pre-flight checks.</span><br><span class="line">[upgrade] Running cluster health checks</span><br><span class="line">[upgrade] Fetching available versions to upgrade to</span><br><span class="line">[upgrade/versions] Cluster version: v1<span class="meta">.17</span><span class="meta">.3</span></span><br><span class="line">[upgrade/versions] kubeadm version: v1<span class="meta">.18</span><span class="meta">.0</span></span><br><span class="line">[upgrade/versions] Latest stable version: v1<span class="meta">.18</span><span class="meta">.0</span></span><br><span class="line">[upgrade/versions] Latest version <span class="keyword">in</span> the v1<span class="meta">.17</span> series: v1<span class="meta">.18</span><span class="meta">.0</span></span><br><span class="line"></span><br><span class="line">Components that must be upgraded manually after you have upgraded the control plane with <span class="string">'kubeadm upgrade apply'</span>:</span><br><span class="line">COMPONENT   CURRENT             AVAILABLE</span><br><span class="line">Kubelet     <span class="number">1</span> x v1<span class="meta">.17</span><span class="meta">.3</span>   v1<span class="meta">.18</span><span class="meta">.0</span></span><br><span class="line"></span><br><span class="line">Upgrade to the latest version <span class="keyword">in</span> the v1<span class="meta">.17</span> series:</span><br><span class="line"></span><br><span class="line">COMPONENT            CURRENT   AVAILABLE</span><br><span class="line">API Server           v1<span class="meta">.17</span><span class="meta">.3</span>   v1<span class="meta">.18</span><span class="meta">.0</span></span><br><span class="line">Controller Manager   v1<span class="meta">.17</span><span class="meta">.3</span>   v1<span class="meta">.18</span><span class="meta">.0</span></span><br><span class="line">Scheduler            v1<span class="meta">.17</span><span class="meta">.3</span>   v1<span class="meta">.18</span><span class="meta">.0</span></span><br><span class="line">Kube Proxy           v1<span class="meta">.17</span><span class="meta">.3</span>   v1<span class="meta">.18</span><span class="meta">.0</span></span><br><span class="line">CoreDNS              <span class="number">1.6</span><span class="meta">.5</span>     <span class="number">1.6</span><span class="meta">.7</span></span><br><span class="line">Etcd                 <span class="number">3.4</span><span class="meta">.3</span>     <span class="number">3.4</span><span class="meta">.3</span>-<span class="number">0</span></span><br><span class="line"></span><br><span class="line">You can now apply the upgrade by executing the following command:</span><br><span class="line"></span><br><span class="line">    kubeadm upgrade apply v1<span class="meta">.18</span><span class="meta">.0</span></span><br><span class="line"></span><br><span class="line">_____________________________________________________________________</span><br><span class="line">此命令检查集群是否可以升级，并获取可以升级到的版本。</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意： kubeadm upgrade还会自动续订它在此节点上管理的证书。要选择退出证书更新，–certificate-renewal=false可以使用该标志。有关更多信息，请参阅证书管理指南。<br>选择要升级到的版本，然后运行相应的命令。例如：</p>
</blockquote>
<figure class="highlight vhdl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"># replace x <span class="keyword">with</span> the patch version you picked <span class="keyword">for</span> this upgrade</span><br><span class="line">sudo kubeadm upgrade apply v1.<span class="number">18</span>.x</span><br><span class="line">您应该看到类似于以下的输出：</span><br><span class="line"></span><br><span class="line">[upgrade/config] Making sure the <span class="keyword">configuration</span> <span class="keyword">is</span> correct:</span><br><span class="line">[upgrade/config] Reading <span class="keyword">configuration</span> from the cluster...</span><br><span class="line">[upgrade/config] FYI: You can look at this config <span class="keyword">file</span> <span class="keyword">with</span> <span class="symbol">'kubectl</span> -n kube-system get cm kubeadm-config -oyaml'</span><br><span class="line">[preflight] Running pre-flight checks.</span><br><span class="line">[upgrade] Running cluster health checks</span><br><span class="line">[upgrade/version] You have chosen <span class="keyword">to</span> change the cluster version <span class="keyword">to</span> <span class="string">"v1.18.0"</span></span><br><span class="line">[upgrade/versions] Cluster version: v1.<span class="number">17.3</span></span><br><span class="line">[upgrade/versions] kubeadm version: v1.<span class="number">18.0</span></span><br><span class="line">[upgrade/confirm] Are you sure you want <span class="keyword">to</span> proceed <span class="keyword">with</span> the upgrade? [y/N]: y</span><br><span class="line">[upgrade/prepull] Will prepull images <span class="keyword">for</span> components [kube-apiserver kube-controller-manager kube-scheduler etcd]</span><br><span class="line">[upgrade/prepull] Prepulling image <span class="keyword">for</span> <span class="keyword">component</span> etcd.</span><br><span class="line">[upgrade/prepull] Prepulling image <span class="keyword">for</span> <span class="keyword">component</span> kube-apiserver.</span><br><span class="line">[upgrade/prepull] Prepulling image <span class="keyword">for</span> <span class="keyword">component</span> kube-controller-manager.</span><br><span class="line">[upgrade/prepull] Prepulling image <span class="keyword">for</span> <span class="keyword">component</span> kube-scheduler.</span><br><span class="line">[apiclient] Found <span class="number">1</span> Pods <span class="keyword">for</span> <span class="keyword">label</span> selector k8s-app=upgrade-prepull-kube-controller-manager</span><br><span class="line">[apiclient] Found <span class="number">0</span> Pods <span class="keyword">for</span> <span class="keyword">label</span> selector k8s-app=upgrade-prepull-etcd</span><br><span class="line">[apiclient] Found <span class="number">0</span> Pods <span class="keyword">for</span> <span class="keyword">label</span> selector k8s-app=upgrade-prepull-kube-scheduler</span><br><span class="line">[apiclient] Found <span class="number">1</span> Pods <span class="keyword">for</span> <span class="keyword">label</span> selector k8s-app=upgrade-prepull-kube-apiserver</span><br><span class="line">[apiclient] Found <span class="number">1</span> Pods <span class="keyword">for</span> <span class="keyword">label</span> selector k8s-app=upgrade-prepull-etcd</span><br><span class="line">[apiclient] Found <span class="number">1</span> Pods <span class="keyword">for</span> <span class="keyword">label</span> selector k8s-app=upgrade-prepull-kube-scheduler</span><br><span class="line">[upgrade/prepull] Prepulled image <span class="keyword">for</span> <span class="keyword">component</span> etcd.</span><br><span class="line">[upgrade/prepull] Prepulled image <span class="keyword">for</span> <span class="keyword">component</span> kube-apiserver.</span><br><span class="line">[upgrade/prepull] Prepulled image <span class="keyword">for</span> <span class="keyword">component</span> kube-controller-manager.</span><br><span class="line">[upgrade/prepull] Prepulled image <span class="keyword">for</span> <span class="keyword">component</span> kube-scheduler.</span><br><span class="line">[upgrade/prepull] Successfully prepulled the images <span class="keyword">for</span> <span class="keyword">all</span> the control plane components</span><br><span class="line">[upgrade/apply] Upgrading your Static Pod-hosted control plane <span class="keyword">to</span> version <span class="string">"v1.18.0"</span>...</span><br><span class="line">Static pod: kube-apiserver-myhost hash: <span class="number">2</span>cc222e1a577b40a8c2832320db54b46</span><br><span class="line">Static pod: kube-controller-manager-myhost hash: f7ce4bc35cb6e646161578ac69910f18</span><br><span class="line">Static pod: kube-scheduler-myhost hash: e3025acd90e7465e66fa19c71b916366</span><br><span class="line">[upgrade/etcd] Upgrading <span class="keyword">to</span> TLS <span class="keyword">for</span> etcd</span><br><span class="line">[upgrade/etcd] Non fatal issue encountered during upgrade: the desired etcd version <span class="keyword">for</span> this Kubernetes version <span class="string">"v1.18.0"</span> <span class="keyword">is</span> <span class="string">"3.4.3-0"</span>, but the current etcd version <span class="keyword">is</span> <span class="string">"3.4.3"</span>. Won<span class="symbol">'t</span> downgrade etcd, instead just continue</span><br><span class="line">[upgrade/staticpods] Writing <span class="keyword">new</span> Static Pod manifests <span class="keyword">to</span> <span class="string">"/etc/kubernetes/tmp/kubeadm-upgraded-manifests308527012"</span></span><br><span class="line">W0308 <span class="number">18</span>:<span class="number">48</span>:<span class="number">14.535122</span>    <span class="number">3082</span> manifests.go:<span class="number">225</span>] the <span class="keyword">default</span> kube-apiserver authorization-mode <span class="keyword">is</span> <span class="string">"Node,RBAC"</span>; using <span class="string">"Node,RBAC"</span></span><br><span class="line">[upgrade/staticpods] Preparing <span class="keyword">for</span> <span class="string">"kube-apiserver"</span> upgrade</span><br><span class="line">[upgrade/staticpods] Renewing apiserver certificate</span><br><span class="line">[upgrade/staticpods] Renewing apiserver-kubelet-client certificate</span><br><span class="line">[upgrade/staticpods] Renewing front-proxy-client certificate</span><br><span class="line">[upgrade/staticpods] Renewing apiserver-etcd-client certificate</span><br><span class="line">[upgrade/staticpods] Moved <span class="keyword">new</span> manifest <span class="keyword">to</span> <span class="string">"/etc/kubernetes/manifests/kube-apiserver.yaml"</span> <span class="keyword">and</span> backed up old manifest <span class="keyword">to</span> <span class="string">"/etc/kubernetes/tmp/kubeadm-backup-manifests-2020-03-08-18-48-14/kube-apiserver.yaml"</span></span><br><span class="line">[upgrade/staticpods] Waiting <span class="keyword">for</span> the kubelet <span class="keyword">to</span> restart the <span class="keyword">component</span></span><br><span class="line">[upgrade/staticpods] This might take a minute <span class="keyword">or</span> longer depending <span class="keyword">on</span> the <span class="keyword">component</span>/version gap (timeout <span class="number">5</span>m0s)</span><br><span class="line">Static pod: kube-apiserver-myhost hash: <span class="number">2</span>cc222e1a577b40a8c2832320db54b46</span><br><span class="line">Static pod: kube-apiserver-myhost hash: <span class="number">609429</span>acb0d71dce6725836dd97d8bf4</span><br><span class="line">[apiclient] Found <span class="number">1</span> Pods <span class="keyword">for</span> <span class="keyword">label</span> selector <span class="keyword">component</span>=kube-apiserver</span><br><span class="line">[upgrade/staticpods] <span class="keyword">Component</span> <span class="string">"kube-apiserver"</span> upgraded successfully!</span><br><span class="line">[upgrade/staticpods] Preparing <span class="keyword">for</span> <span class="string">"kube-controller-manager"</span> upgrade</span><br><span class="line">[upgrade/staticpods] Renewing controller-manager.conf certificate</span><br><span class="line">[upgrade/staticpods] Moved <span class="keyword">new</span> manifest <span class="keyword">to</span> <span class="string">"/etc/kubernetes/manifests/kube-controller-manager.yaml"</span> <span class="keyword">and</span> backed up old manifest <span class="keyword">to</span> <span class="string">"/etc/kubernetes/tmp/kubeadm-backup-manifests-2020-03-08-18-48-14/kube-controller-manager.yaml"</span></span><br><span class="line">[upgrade/staticpods] Waiting <span class="keyword">for</span> the kubelet <span class="keyword">to</span> restart the <span class="keyword">component</span></span><br><span class="line">[upgrade/staticpods] This might take a minute <span class="keyword">or</span> longer depending <span class="keyword">on</span> the <span class="keyword">component</span>/version gap (timeout <span class="number">5</span>m0s)</span><br><span class="line">Static pod: kube-controller-manager-myhost hash: f7ce4bc35cb6e646161578ac69910f18</span><br><span class="line">Static pod: kube-controller-manager-myhost hash: c7a1232ba2c5dc15641c392662fe5156</span><br><span class="line">[apiclient] Found <span class="number">1</span> Pods <span class="keyword">for</span> <span class="keyword">label</span> selector <span class="keyword">component</span>=kube-controller-manager</span><br><span class="line">[upgrade/staticpods] <span class="keyword">Component</span> <span class="string">"kube-controller-manager"</span> upgraded successfully!</span><br><span class="line">[upgrade/staticpods] Preparing <span class="keyword">for</span> <span class="string">"kube-scheduler"</span> upgrade</span><br><span class="line">[upgrade/staticpods] Renewing scheduler.conf certificate</span><br><span class="line">[upgrade/staticpods] Moved <span class="keyword">new</span> manifest <span class="keyword">to</span> <span class="string">"/etc/kubernetes/manifests/kube-scheduler.yaml"</span> <span class="keyword">and</span> backed up old manifest <span class="keyword">to</span> <span class="string">"/etc/kubernetes/tmp/kubeadm-backup-manifests-2020-03-08-18-48-14/kube-scheduler.yaml"</span></span><br><span class="line">[upgrade/staticpods] Waiting <span class="keyword">for</span> the kubelet <span class="keyword">to</span> restart the <span class="keyword">component</span></span><br><span class="line">[upgrade/staticpods] This might take a minute <span class="keyword">or</span> longer depending <span class="keyword">on</span> the <span class="keyword">component</span>/version gap (timeout <span class="number">5</span>m0s)</span><br><span class="line">Static pod: kube-scheduler-myhost hash: e3025acd90e7465e66fa19c71b916366</span><br><span class="line">Static pod: kube-scheduler-myhost hash: b1b721486ae0ac504c160dcdc457ab0d</span><br><span class="line">[apiclient] Found <span class="number">1</span> Pods <span class="keyword">for</span> <span class="keyword">label</span> selector <span class="keyword">component</span>=kube-scheduler</span><br><span class="line">[upgrade/staticpods] <span class="keyword">Component</span> <span class="string">"kube-scheduler"</span> upgraded successfully!</span><br><span class="line">[upload-config] Storing the <span class="keyword">configuration</span> used <span class="keyword">in</span> ConfigMap <span class="string">"kubeadm-config"</span> <span class="keyword">in</span> the <span class="string">"kube-system"</span> Namespace</span><br><span class="line">[kubelet] Creating a ConfigMap <span class="string">"kubelet-config-1.18"</span> <span class="keyword">in</span> namespace kube-system <span class="keyword">with</span> the <span class="keyword">configuration</span> <span class="keyword">for</span> the kubelets <span class="keyword">in</span> the cluster</span><br><span class="line">[kubelet-start] Downloading <span class="keyword">configuration</span> <span class="keyword">for</span> the kubelet from the <span class="string">"kubelet-config-1.18"</span> ConfigMap <span class="keyword">in</span> the kube-system namespace</span><br><span class="line">[kubelet-start] Writing kubelet <span class="keyword">configuration</span> <span class="keyword">to</span> <span class="keyword">file</span> <span class="string">"/var/lib/kubelet/config.yaml"</span></span><br><span class="line">[bootstrap-token] configured RBAC rules <span class="keyword">to</span> allow Node Bootstrap tokens <span class="keyword">to</span> post CSRs <span class="keyword">in</span> order <span class="keyword">for</span> nodes <span class="keyword">to</span> get long term certificate credentials</span><br><span class="line">[bootstrap-token] configured RBAC rules <span class="keyword">to</span> allow the csrapprover controller automatically approve CSRs from a Node Bootstrap Token</span><br><span class="line">[bootstrap-token] configured RBAC rules <span class="keyword">to</span> allow certificate rotation <span class="keyword">for</span> <span class="keyword">all</span> node client certificates <span class="keyword">in</span> the cluster</span><br><span class="line">[addons] Applied essential addon: CoreDNS</span><br><span class="line">[addons] Applied essential addon: kube-proxy</span><br><span class="line"></span><br><span class="line">[upgrade/successful] SUCCESS! Your cluster was upgraded <span class="keyword">to</span> <span class="string">"v1.18.0"</span>. Enjoy!</span><br><span class="line"></span><br><span class="line">[upgrade/kubelet] Now that your control plane <span class="keyword">is</span> upgraded, please proceed <span class="keyword">with</span> upgrading your kubelets <span class="keyword">if</span> you haven<span class="symbol">'t</span> already done so.</span><br><span class="line">手动升级您的CNI提供程序插件。</span><br></pre></td></tr></table></figure>
<blockquote>
<p>您的容器网络接口（CNI）提供程序可能有其自己的升级说明。检查插件页面以找到您的CNI提供程序，并查看是否需要其他升级步骤。</p>
</blockquote>
<blockquote>
<p>取消控制平面节点的密码：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># replace &lt;cp-node-name&gt; with the name of your control plane node</span></span><br><span class="line">kubectl uncordon &lt;cp-node-name&gt;</span><br><span class="line">升级其他控制平面节点</span><br><span class="line">与第一个控制平面节点相同，但使用：</span><br><span class="line"></span><br><span class="line">sudo kubeadm<span class="built_in"> upgrade </span>node</span><br><span class="line">代替：</span><br><span class="line"></span><br><span class="line">sudo kubeadm<span class="built_in"> upgrade </span>apply</span><br><span class="line">也sudo kubeadm<span class="built_in"> upgrade </span>plan没有必要。</span><br></pre></td></tr></table></figure></p>
</blockquote>
<blockquote>
<p>升级kubelet和kubectl<br>在所有控制平面节点上升级kubelet和kubectl：<br>Ubuntu，Debian或HypriotOSCentOS，RHEL或Fedora</p>
</blockquote>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># replace x in <span class="number">1.18</span>.x<span class="number">-0</span> with the latest patch version</span><br><span class="line">yum install -y kubelet<span class="number">-1.18</span>.x<span class="number">-0</span> kubectl<span class="number">-1.18</span>.x<span class="number">-0</span> --disableexcludes=kubernetes</span><br><span class="line">重新启动kubelet</span><br><span class="line">sudo systemctl restart kubelet</span><br></pre></td></tr></table></figure>
<blockquote>
<p>升级工作程序节点<br>在不牺牲运行工作负载所需的最小容量的前提下，应在一个工作节点上一次执行一个升级程序，或者一次执行几个节点。</p>
</blockquote>
<blockquote>
<p>升级kubeadm<br>在所有工作节点上升级kubeadm：<br>Ubuntu，Debian或HypriotOSCentOS，RHEL或Fedora<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># replace x in <span class="number">1.18</span>.x<span class="number">-0</span> with the latest patch version</span><br><span class="line">yum install -y kubeadm<span class="number">-1.18</span>.x<span class="number">-0</span> --disableexcludes=kubernetes</span><br></pre></td></tr></table></figure></p>
</blockquote>
<blockquote>
<p>排空节点<br>通过将节点标记为不可计划并逐出工作负载来准备要维护的节点：<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># replace &lt;node-to-drain&gt; with the name of your node you are draining</span></span><br><span class="line">kubectl drain <span class="tag">&lt;node-to-drain&gt;</span> --ignore-daemonsets</span><br><span class="line">您应该看到类似于以下的输出：</span><br><span class="line"></span><br><span class="line"><span class="keyword">node</span><span class="title">/ip-172-31-85-18</span> cordoned</span><br><span class="line">WARNING: ignoring DaemonSet-managed Pods: kube-system/kube-proxy-dj7d7, kube-system/weave-net-z65qx</span><br><span class="line"><span class="keyword">node</span><span class="title">/ip-172-31-85-18</span> drained</span><br></pre></td></tr></table></figure></p>
</blockquote>
<blockquote>
<p>升级kubelet配置<br>调用以下命令：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo kubeadm<span class="built_in"> upgrade </span>node</span><br></pre></td></tr></table></figure></p>
</blockquote>
<blockquote>
<p>升级kubelet和kubectl<br>在所有工作节点上升级kubelet和kubectl：<br>Ubuntu，Debian或HypriotOSCentOS，RHEL或Fedora<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># replace x in <span class="number">1.18</span>.x<span class="number">-0</span> with the latest patch version</span><br><span class="line">yum install -y kubelet<span class="number">-1.18</span>.x<span class="number">-0</span> kubectl<span class="number">-1.18</span>.x<span class="number">-0</span> --disableexcludes=kubernetes</span><br></pre></td></tr></table></figure></p>
</blockquote>
<blockquote>
<p>重新启动kubelet<br><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">sudo systemctl restart kubelet</span></span><br></pre></td></tr></table></figure></p>
</blockquote>
<blockquote>
<p>取消密码节点<br>通过将节点标记为可调度来使其重新联机：<br><figure class="highlight delphi"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># replace &lt;node-<span class="keyword">to</span>-drain&gt; <span class="keyword">with</span> the <span class="keyword">name</span> <span class="keyword">of</span> your node</span><br><span class="line">kubectl uncordon &lt;node-<span class="keyword">to</span>-drain&gt;</span><br></pre></td></tr></table></figure></p>
</blockquote>
<h4 id="验证集群的状态"><a href="#验证集群的状态" class="headerlink" title="验证集群的状态"></a>验证集群的状态</h4><blockquote>
<p>在所有节点上升级kubelet之后，通过在kubectl可以访问群集的任何位置运行以下命令来验证所有节点是否再次可用：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="builtin-name">get</span> nodes</span><br><span class="line">该STATUS列应显示Ready所有节点，并且应更新版本号。</span><br></pre></td></tr></table></figure></p>
</blockquote>
<blockquote>
<p>从故障状态中恢复<br>如果kubeadm upgrade失败并且不回滚（例如由于执行期间意外关闭），则可以kubeadm upgrade再次运行。此命令是幂等的，并最终确保实际状态是您声明的所需状态。<br><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">要从不良状态中恢复，您也可以在kubeadm upgrade apply --force不更改集群运行版本的情况下运行。</span><br><span class="line"></span><br><span class="line">在升级期间，kubeadm在以下位置写入以下备份文件夹/etc/kubernetes/tmp：kubeadm-backup-etcd-&lt;date&gt;-&lt;time&gt; --kubeadm-backup-manifests-&lt;date&gt;-&lt;time&gt;</span><br><span class="line"></span><br><span class="line">kubeadm-backup-etcd包含此控制平面节点的本地etcd成员数据的备份。如果etcd升级失败并且自动回滚不起作用，则可以在中手动还原此文件夹的内容/var/<span class="class"><span class="keyword">lib</span>/<span class="title">etcd</span>。如果使用外部<span class="title">etcd</span>，则此备份文件夹将为空。</span></span><br><span class="line"></span><br><span class="line">kubeadm-backup-manifests包含此控制平面节点的静态Pod清单文件的备份。如果升级失败并且自动回滚不起作用，则可以在中手动还原此文件夹的内容/etc/kubernetes/manifests。如果某个组件的升级前清单文件和升级后清单文件之间没有区别，则不会写入该文件的备份文件。</span><br></pre></td></tr></table></figure></p>
</blockquote>
</div></header><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a class="post__tag__link" href="/tags/kubeadm-kubernetes-golang/">-kubeadm -kubernetes -golang</a></li></ul></footer></article><section class="reward"><a class="btn-reward" href="#">打赏</a><div class="reward-wrapper clearfix"><img src="/img/wechat20.png" title="微信"></div></section></main><footer class="foot"><div class="foot-copy">&copy; 2016 - 2021 Willie Lin</div></footer><script src="/js/scroller.js"></script><script src="/js/main.js"></script></body></html>